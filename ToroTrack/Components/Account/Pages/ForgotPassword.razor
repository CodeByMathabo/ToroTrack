@page "/Account/ForgotPassword"

@using System.ComponentModel.DataAnnotations
@using System.Text
@using System.Text.Encodings.Web
@using Microsoft.AspNetCore.Identity
@using Microsoft.AspNetCore.WebUtilities
@using ToroTrack.Data
@using ToroTrack.Components

@inject UserManager<ApplicationUser> UserManager
@inject IEmailSender<ApplicationUser> EmailSender
@inject NavigationManager NavigationManager
@inject IdentityRedirectManager RedirectManager

<PageTitle>Reset Password</PageTitle>

@* Why: This container breaks out of the main layout to center everything fullscreen *@
<div class="auth-fullscreen-container">
    <div class="toro-auth-card">
        <h1 class="auth-header">Reset Password</h1>
        @* Why: The requested instruction label below the header *@
        <p class="auth-instruction">Enter your email address below to receive a password reset link.</p>

        <EditForm Model="Input" FormName="forgot-password" OnValidSubmit="OnValidSubmitAsync" method="post">
            <DataAnnotationsValidator />
            @* Why: Keeping summary for validation errors, but using snackbar for submission results *@
            <ValidationSummary class="text-danger text-center mb-3" role="alert" />

            <div class="form-floating mb-4">
                <InputText @bind-Value="Input.Email"
                           class="form-control"
                           autocomplete="username"
                           aria-required="true"
                           placeholder="name@example.com"
                           id="email-input" />
                <label for="email-input">Email Address</label>
                <ValidationMessage For="() => Input.Email" class="text-danger" />
            </div>

            @* Why: Flex container to put buttons side-by-side with a specific gap *@
            <div class="button-group-gap">
                <button type="submit" class="btn btn-lg btn-primary-toro flex-grow-1">Send Reset Link</button>
                @* Why: Secondary button styled as an outline to differentiate actions *@
                <a href="Account/Login" class="btn btn-lg btn-primary-toro flex-grow-1">Back To Login</a>
            </div>
        </EditForm>
    </div>
</div>

@* Why: The reusable component handles displaying success or error messages at the bottom *@
<Snackbar @bind-IsVisible="_showSnackbar" Message="@_snackbarMessage" IsSuccess="@_isSuccess" />


@code {
    [SupplyParameterFromForm]
    private InputModel Input { get; set; } = new();

    // Snackbar state variables
    private bool _showSnackbar;
    private string _snackbarMessage = "";
    private bool _isSuccess;

    private async Task OnValidSubmitAsync()
    {
        // Reset UI state before processing
        _showSnackbar = false;
        StateHasChanged();

        try
        {
            var user = await UserManager.FindByEmailAsync(Input.Email);
            // Why: Security practice - Don't reveal if user doesn't exist or isn't confirmed
            if (user is null || !(await UserManager.IsEmailConfirmedAsync(user)))
            {
                // Fake success to prevent email enumeration
                ShowSuccessMessage();
                return;
            }

            var code = await UserManager.GeneratePasswordResetTokenAsync(user);
            code = WebEncoders.Base64UrlEncode(Encoding.UTF8.GetBytes(code));
            var callbackUrl = NavigationManager.GetUriWithQueryParameters(
                NavigationManager.ToAbsoluteUri("Account/ResetPassword").AbsoluteUri,
                new Dictionary<string, object?> { ["code"] = code });

            Console.WriteLine($"Attempting to send reset email to: {Input.Email}");
            await EmailSender.SendPasswordResetLinkAsync(user, Input.Email, HtmlEncoder.Default.Encode(callbackUrl));
            Console.WriteLine("Reset email sent successfully.");

            ShowSuccessMessage();
            // Optional: Clear the form on success
            Input = new();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"ERROR sending password reset email: {ex.Message}");
            // Why: Show error snackbar so the user knows something went wrong internally
            _isSuccess = false;
            _snackbarMessage = "An error occurred sending the email. Please try again later.";
            _showSnackbar = true;
        }
    }

    private void ShowSuccessMessage()
    {
        _isSuccess = true;
        _snackbarMessage = "If an account exists for that email, a reset link has been sent.";
        _showSnackbar = true;
    }

    private sealed class InputModel
    {
        [Required]
        [EmailAddress]
        public string Email { get; set; } = "";
    }
}