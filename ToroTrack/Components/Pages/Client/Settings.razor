@page "/client/settings"
@using Microsoft.AspNetCore.Authorization
@using System.Security.Claims
@using ToroTrack.Business.Services
@using ToroTrack.Models
@inject AuthenticationStateProvider AuthStateProvider
@inject IClientSettingsService SettingsService
@attribute [Authorize(Roles = "Client")]
@rendermode InteractiveServer

<PageTitle>Settings | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Client Settings</h1>
            <p class="page-subtitle">Manage your notification preferences and account details.</p>
        </div>
        <div class="header-right">
            <button class="btn-primary-toro" @onclick="SaveChanges" disabled="@isSaving">
                @if (isSaving)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span> <span>Saving...</span>
                }
                else
                {
                    <span class="bi bi-save-fill me-2"></span> <span>Save Changes</span>
                }
            </button>
        </div>
    </header>

    @* TABS NAVIGATION *@
    <div class="settings-tabs">
        <button class="tab-link @(ActiveTab == "Notifications" ? "active" : "")" @onclick='() => ActiveTab = "Notifications"'>
            <span class="bi bi-bell"></span> Notifications
        </button>
        <button class="tab-link @(ActiveTab == "Account" ? "active" : "")" @onclick='() => ActiveTab = "Account"'>
            <span class="bi bi-person-badge"></span> Account
        </button>
    </div>

    <div class="settings-content">
        @if (ActiveTab == "Notifications")
        {
            <div class="setting-section">
                <h3 class="section-title">Email Alerts</h3>
                <p class="section-desc">Choose when you want to receive email updates about your project.</p>

                <div class="setting-card">
                    @* TOGGLE 1 *@
                    <div class="toggle-row">
                        <div class="toggle-info">
                            <span class="toggle-label">Milestone Sign-off Ready</span>
                            <p class="toggle-desc">Notify me when a project stage is completed and requires my electronic signature.</p>
                        </div>
                        <label class="toro-switch">
                            <input type="checkbox" @bind="SettingsModel.Preferences.NotifyOnMilestone">
                            <span class="slider"></span>
                        </label>
                    </div>

                    <div class="divider"></div>

                    @* TOGGLE 2 *@
                    <div class="toggle-row">
                        <div class="toggle-info">
                            <span class="toggle-label">Query Responses</span>
                            <p class="toggle-desc">Notify me when an admin replies to my help desk queries.</p>
                        </div>
                        <label class="toro-switch">
                            <input type="checkbox" @bind="SettingsModel.Preferences.NotifyOnQueryReply">
                            <span class="slider"></span>
                        </label>
                    </div>
                    
                    <div class="divider"></div>

                    @* TOGGLE 3 *@
                    <div class="toggle-row">
                        <div class="toggle-info">
                            <span class="toggle-label">Meeting Confirmations</span>
                            <p class="toggle-desc">Receive calendar invites when a requested meeting is confirmed by an admin.</p>
                        </div>
                        <label class="toro-switch">
                            <input type="checkbox" @bind="SettingsModel.Preferences.NotifyOnMeeting">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
        }

        @if (ActiveTab == "Account")
        {
             <div class="setting-section">
                <h3 class="section-title">Account Details</h3>
                <p class="section-desc">Update your personal and organization information.</p>

                <div class="setting-card">
                    <div class="form-group mb-3">
                        <label class="small-label">Company Name</label>
                        <input @bind="SettingsModel.Account.CompanyName" class="form-control" placeholder="Enter company name" />
                    </div>

                    <div class="form-group mb-3">
                        <label class="small-label">Email Address</label>
                        <input @bind="SettingsModel.Account.Email" class="form-control" placeholder="name@company.com" type="email" />
                    </div>

                    <div class="form-group mb-3">
                        <label class="small-label">Contact Number</label>
                        <input @bind="SettingsModel.Account.ContactNumber" class="form-control" placeholder="+27 XX XXX XXXX" />
                    </div>
                </div>
            </div>
        }
    </div>
    
    @* SUCCESS TOAST *@
    @if (showSuccessMessage)
    {
        <div class="save-toast">
            <span class="bi bi-check-circle-fill"></span> Changes Saved Successfully!
        </div>
    }
</div>

@code {
    private string ActiveTab = "Notifications";
    private bool isSaving = false;
    private bool showSuccessMessage = false;
    private string currentUserId = "";

    // View Model containing both sections
    private ClientSettingsViewModel SettingsModel = new();

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                currentUserId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value ?? "";
                if (!string.IsNullOrEmpty(currentUserId))
                {
                    // Fetch existing data from DB
                    SettingsModel = await SettingsService.GetSettingsForUserAsync(currentUserId);
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading settings: {ex.Message}");
        }
    }

    private async Task SaveChanges()
    {
        if (string.IsNullOrEmpty(currentUserId)) return;

        isSaving = true;
        
        try 
        {
            // Pass the model to service to save to DB
            await SettingsService.UpdateSettingsAsync(currentUserId, SettingsModel);
            
            showSuccessMessage = true;
            StateHasChanged(); // Force UI refresh for toast
            
            await Task.Delay(3000);
            showSuccessMessage = false;
        }
        catch (Exception ex)
        {
             Console.WriteLine($"Error saving settings: {ex.Message}");
        }
        finally
        {
            isSaving = false;
        }
    }
}