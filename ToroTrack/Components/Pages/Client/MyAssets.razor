@page "/client/assets"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using ToroTrack.Components.Layout
@using ToroTrack.Data
@using ToroTrack.Data.Entities

@attribute [Authorize(Roles = "Client")]
@rendermode InteractiveServer

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject ILogger<MyAssets> Logger

<PageTitle>My Assets | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div>
            <h1 class="page-title">Assets & Licenses</h1>
            <p class="page-subtitle">Track your organization's hardware inventory and software subscriptions.</p>
        </div>
        @if (!IsLoading)
        {
            <div class="header-right">
                <div class="summary-badge">
                    <span class="bi bi-pc-display me-2"></span>
                    @HardwareList.Count Devices
                </div>
                <div class="summary-badge ms-2">
                    <span class="bi bi-card-checklist me-2"></span>
                    @SoftwareList.Count Active Licenses
                </div>
            </div>
        }
    </header>

    @if (IsLoading)
    {
        <div class="p-5 text-center text-muted">
            <div class="spinner-border text-success mb-3" role="status"></div>
            <p>Syncing your asset inventory...</p>
        </div>
    }
    else if (!HardwareList.Any() && !SoftwareList.Any())
    {
        <div class="empty-state">
            <div class="alert alert-info border-0 shadow-sm">
                <span class="bi bi-info-circle-fill me-2"></span>
                You have no registered assets yet. Assets appear here once delivered by the Logistics team.
            </div>
        </div>
    }
    else
    {
        <div class="assets-grid">

            @* --- SECTION 1: SOFTWARE LICENSES --- *@
            @if (SoftwareList.Any())
            {
                <section class="asset-section">
                    <h3 class="section-header">
                        <span class="bi bi-microsoft me-2"></span> Software Licenses
                    </h3>
                    <div class="table-responsive">
                        <table class="toro-table">
                            <thead>
                                <tr>
                                    <th style="width: 40%">Software Name</th>
                                    <th style="width: 30%">Assigned Date</th>
                                    <th style="width: 30%" class="text-center">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var license in SoftwareList)
                                {
                                    <tr>
                                        <td class="fw-bold">@license.Name</td>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <span class="bi bi-calendar-check me-2 text-muted"></span>
                                                @license.AssignedDate.ToString("MMM dd, yyyy")
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <span class="status-pill @(license.Status == "Active" ? "active" : "expired")">
                                                @license.Status
                                            </span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </section>
            }

            @* --- SECTION 2: HARDWARE INVENTORY --- *@
            @if (HardwareList.Any())
            {
                <section class="asset-section mt-4">
                    <h3 class="section-header">
                        <span class="bi bi-laptop me-2"></span> Hardware Inventory
                    </h3>
                    <div class="table-responsive">
                        <table class="toro-table">
                            <thead>
                                <tr>
                                    <th style="width: 30%">Device Name</th>
                                    <th style="width: 25%">Description</th>
                                    <th style="width: 20%">Assigned Date</th>
                                    <th style="width: 25%">Serial No.</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in HardwareList)
                                {
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center gap-2">
                                                @* Why: Differentiate icon based on description or default to laptop *@
                                                @if (item.Name.Contains("Server") || item.Name.Contains("System"))
                                                {
                                                    <span class="bi bi-hdd-rack-fill text-muted fs-5"></span>
                                                }
                                                else
                                                {
                                                    <span class="bi bi-laptop-fill text-muted fs-5"></span>
                                                }
                                                <span class="fw-bold">@item.Name</span>
                                            </div>
                                        </td>
                                        <td class="text-muted small">
                                            @(string.IsNullOrEmpty(item.Description) ? "Standard Asset" : item.Description)
                                        </td>
                                        <td>
                                            @item.AssignedDate.ToString("MMM dd, yyyy")
                                        </td>
                                        <td class="text-monospace text-primary">
                                            @if (!string.IsNullOrEmpty(item.SerialNumber))
                                            {
                                                <span class="bi bi-upc-scan me-1"></span> 
                                                @item.SerialNumber
                                            }
                                            else
                                            {
                                                <span class="text-muted fst-italic">Pending</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </section>
            }
        </div>
    }
</div>

@code {
    // --- MODELS ---
    // Why: Using a ViewModel to flatten DB data for easier UI binding
    public class AssetViewModel
    {
        public int Id { get; set; }
        public string Name { get; set; } = "";
        public string Description { get; set; } = "";
        public string SerialNumber { get; set; } = "";
        public DateTime AssignedDate { get; set; }
        public string Status { get; set; } = "Active";
        public string Category { get; set; } = "Hardware";
    }

    // --- STATE ---
    private bool IsLoading = true;
    private List<AssetViewModel> HardwareList = new();
    private List<AssetViewModel> SoftwareList = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            IsLoading = true;

            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                var userId = UserManager.GetUserId(user);
                if (!string.IsNullOrEmpty(userId))
                {
                    await LoadAssetsForUser(userId);
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading client assets.");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadAssetsForUser(string userId)
    {
        using var context = DbFactory.CreateDbContext();

        // Why: Fetch assets belonging to this user
        var rawAssets = await context.ClientAssets
            .Where(a => a.ClientId == userId)
            .ToListAsync();

        // Why: We need to know the Category (Hardware vs Software).
        // Logic: If linked to a CatalogItem, check its category. If null (Custom Project), assume Hardware.

        // 1. Get IDs of linked catalog items
        var catalogIds = rawAssets
            .Where(a => a.CatalogItemId.HasValue)
            .Select(a => a.CatalogItemId!.Value)
            .Distinct()
            .ToList();

        // 2. Fetch those catalog items to get their categories
        var catalogMap = await context.CatalogItems
            .Where(c => catalogIds.Contains(c.Id))
            .ToDictionaryAsync(c => c.Id, c => c.Category);

        var allAssets = new List<AssetViewModel>();

        foreach (var asset in rawAssets)
        {
            string category = "Hardware"; // Default

            // Why: Determine category based on catalog item if it exists
            if (asset.CatalogItemId.HasValue && catalogMap.ContainsKey(asset.CatalogItemId.Value))
            {
                category = catalogMap[asset.CatalogItemId.Value];
            }

            allAssets.Add(new AssetViewModel
            {
                Id = asset.Id,
                Name = asset.Name,
                Description = asset.Description,
                SerialNumber = asset.SerialNumber ?? "N/A",
                AssignedDate = asset.AssignedDate,
                Status = asset.Status,
                Category = category
            });
        }

        // Why: Split into two lists for the UI sections
        HardwareList = allAssets.Where(a => a.Category == "Hardware").ToList();
        SoftwareList = allAssets.Where(a => a.Category == "Software").ToList();

        Logger.LogInformation($"Loaded {HardwareList.Count} hardware and {SoftwareList.Count} software assets for user {userId}");
    }
}