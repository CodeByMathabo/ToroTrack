@page "/client/order-assets"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using ToroTrack.Components.Layout
@using ToroTrack.Data
@using ToroTrack.Data.Entities

@rendermode InteractiveServer

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject ILogger<OrderAssets> Logger

<PageTitle>Order Assets | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Order Assets</h1>
            <p class="page-subtitle">Request new hardware and software licenses for your team.</p>
        </div>
        <div class="header-right">
            <div class="cart-summary" @onclick="OpenCartModal">
                <span class="bi bi-cart3 cart-icon"></span>
                <span class="cart-count">@Cart.Sum(i => i.Quantity)</span>
                <span class="cart-total">R @Cart.Sum(i => i.TotalCost).ToString("N0")</span>
            </div>
        </div>
    </header>

    @* FEEDBACK MESSAGES *@
    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> @SuccessMessage
            <button type="button" class="btn-close" @onclick='() => SuccessMessage = ""'></button>
        </div>
    }
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @ErrorMessage
            <button type="button" class="btn-close" @onclick='() => ErrorMessage = ""'></button>
        </div>
    }

    @* CATEGORY TABS *@
    <div class="category-tabs">
        <button class="tab-btn @(ActiveCategory == "All" ? "active" : "")" @onclick='() => ActiveCategory = "All"'>All</button>
        <button class="tab-btn @(ActiveCategory == "Hardware" ? "active" : "")" @onclick='() => ActiveCategory = "Hardware"'>Hardware</button>
        <button class="tab-btn @(ActiveCategory == "Software" ? "active" : "")" @onclick='() => ActiveCategory = "Software"'>Software</button>
    </div>

    @* ASSET CATALOG GRID *@
    <div class="catalog-grid">
        @if (IsLoading)
        {
             <div class="col-span-full text-center py-5 text-muted">
                <div class="spinner-border text-primary mb-2" role="status"></div>
                <p>Loading catalog...</p>
             </div>
        }
        else
        {
            @foreach (var item in FilteredCatalog)
            {
                <div class="asset-card @(item.StockQuantity == 0 && item.Category == "Hardware" ? "out-of-stock" : "")">
                    @* COLORED HEADER *@
                    <div class="card-type-header @item.Category.ToLower()">
                        <span>@item.Category</span>
                    </div>

                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h3 class="asset-title">@item.Name</h3>
                            <span class="price-tag">R @item.Cost.ToString("N0")</span>
                        </div>

                        @* STOCK INDICATOR *@
                        <div class="mb-2">
                            @if (item.Category == "Hardware")
                            {
                                @if (item.StockQuantity == 0)
                                {
                                    <span class="stock-badge out">Out of Stock</span>
                                }
                                else if (item.StockQuantity < 5)
                                {
                                    <span class="stock-badge low">Only @item.StockQuantity left!</span>
                                }
                                else
                                {
                                    <span class="stock-badge good">In Stock</span>
                                }
                            }
                            else
                            {
                                <span class="stock-badge digital">Digital License</span>
                            }
                        </div>

                        <p class="asset-desc">@item.Description</p>

                        @* SMART ACTION BUTTON *@
                        @if (item.Category == "Hardware" && item.StockQuantity == 0)
                        {
                            <button class="btn-add-solid disabled" disabled>
                                Unavailable
                            </button>
                        }
                        else
                        {
                            <button class="btn-add-solid" @onclick="() => AddToCart(item)">
                                Add to Order
                            </button>
                        }
                    </div>
                </div>
            }
        }
    </div>
</div>

@* CHECKOUT MODAL *@
<ToroModal @bind-IsVisible="isCartVisible" Title="Confirm Order">
    <div class="cart-modal-content">
        @if (Cart.Any())
        {
            @* --- NEW: DELIVERY DETAILS SECTION --- *@
            <div class="bg-light p-3 rounded mb-4 border">
                <h6 class="fw-bold mb-3"><i class="bi bi-truck me-2"></i>Delivery Details</h6>
                
                <div class="form-group mb-3">
                    <label class="small-label fw-bold">Delivery Address</label>
                    <textarea class="form-control" rows="2" 
                              placeholder="Office 3, Building A, Tech Park..."
                              @bind="DeliveryAddress"></textarea>
                </div>

                <div class="form-group">
                    <label class="small-label fw-bold">Site Contact Number</label>
                    <input type="text" class="form-control" 
                           placeholder="+27 82 000 0000"
                           @bind="ContactNumber" />
                </div>
            </div>

            <table class="toro-table mb-4">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th class="text-center">Qty</th>
                        <th class="text-end">Price</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var cartItem in Cart)
                    {
                        <tr>
                            <td>
                                <div class="fw-bold">@cartItem.ItemName</div>
                                <small class="text-muted">@cartItem.Category</small>
                            </td>
                            <td class="text-center">
                                <span class="badge bg-light text-dark border">x @cartItem.Quantity</span>
                            </td>
                            <td class="text-end">R @cartItem.TotalCost.ToString("N0")</td>
                            <td class="text-center">
                                <button class="btn-remove-solid" @onclick="() => RemoveFromCart(cartItem)">
                                    Remove
                                </button>
                            </td>
                        </tr>
                    }
                    <tr class="total-row">
                        <td class="fw-bold text-end" colspan="2">TOTAL</td>
                        <td class="fw-bold text-end">R @Cart.Sum(i => i.TotalCost).ToString("N0")</td>
                        <td></td>
                    </tr>
                </tbody>
            </table>

            <div class="alert alert-info small mb-3">
                <span class="bi bi-info-circle-fill me-2"></span>
                <strong>Note:</strong> Placing this order will automatically create a request on the Logistics Dashboard.
            </div>

            <div class="d-flex justify-content-end gap-2">
                <button class="btn-secondary-toro" @onclick="() => isCartVisible = false">Keep Shopping</button>
                <button class="btn-primary-toro" @onclick="PlaceOrder" disabled="@IsSaving">
                    @if (IsSaving)
                    {
                       <span class="spinner-border spinner-border-sm me-1"></span> <span>Processing...</span>
                    }
                    else
                    {
                        <span>Confirm Order</span>
                    }
                </button>
            </div>
        }
        else
        {
            <div class="text-center py-5 text-muted">
                <p class="mb-3">Your cart is empty.</p>
                <button class="btn-primary-toro mt-3" @onclick="() => isCartVisible = false">Browse Catalog</button>
            </div>
        }
    </div>
</ToroModal>

@code {
    // UI State
    private string ActiveCategory = "All";
    private bool isCartVisible = false;
    private bool IsLoading = true;
    private bool IsSaving = false;
    private string ErrorMessage = "";
    private string SuccessMessage = "";

    // New Delivery Inputs
    private string DeliveryAddress = "";
    private string ContactNumber = "";

    // Data State
    private List<CatalogItem> Catalog = new();
    private List<CartItemViewModel> Cart = new();
    private ApplicationUser? CurrentUser;
    private Project? ActiveProject;
    private IEnumerable<CatalogItem> FilteredCatalog =>
        ActiveCategory == "All" ? Catalog : Catalog.Where(i => i.Category == ActiveCategory);

    // Initial Data Load
    protected override async Task OnInitializedAsync()
    {
        await LoadUserAndProject();
        await LoadCatalog();
    }

    private async Task LoadUserAndProject()
    {
        try 
        {
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var userPrincipal = authState.User;

            if (userPrincipal.Identity?.IsAuthenticated == true)
            {
                CurrentUser = await UserManager.GetUserAsync(userPrincipal);
                if (CurrentUser != null)
                {
                    using var context = DbFactory.CreateDbContext();
                    ActiveProject = await context.Projects
                        .Where(p => p.ClientId == CurrentUser.Id && p.Status == "Active")
                        .FirstOrDefaultAsync();
                }
            }
        }
        catch(Exception ex)
        {
            Logger.LogError(ex, "Error loading user profile");
        }
    }

    private async Task LoadCatalog()
    {
        try
        {
            IsLoading = true;
            using var context = DbFactory.CreateDbContext();
            Catalog = await context.CatalogItems
                .OrderBy(c => c.Name)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load catalog");
            ErrorMessage = "Could not load products. Please try refreshing.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    // Cart Logic
    private void AddToCart(CatalogItem item)
    {
        ErrorMessage = "";
        SuccessMessage = "";

        // Check stock for hardware
        if (item.Category == "Hardware" && item.StockQuantity <= 0) return;

        var existing = Cart.FirstOrDefault(x => x.CatalogItemId == item.Id);
        if (existing != null)
        {
            existing.Quantity++;
        }
        else
        {
            Cart.Add(new CartItemViewModel
            {
                CatalogItemId = item.Id,
                ItemName = item.Name,
                Category = item.Category,
                UnitCost = item.Cost,
                Quantity = 1
            });
        }
    }

    private void RemoveFromCart(CartItemViewModel item)
    {
        Cart.Remove(item);
    }

    private void OpenCartModal()
    {
        ErrorMessage = "";
        isCartVisible = true;
    }

    // Backend Logic for Order Placement
    private async Task PlaceOrder()
    {
        if (!Cart.Any()) return;
        
        // Validation
        if (string.IsNullOrWhiteSpace(DeliveryAddress) || string.IsNullOrWhiteSpace(ContactNumber))
        {
            ErrorMessage = "Please provide both a Delivery Address and a Contact Number.";
            return;
        }

        IsSaving = true;
        ErrorMessage = "";

        try
        {
            if (CurrentUser == null) 
            {
                ErrorMessage = "You must be logged in to place an order.";
                return;
            }

            if (ActiveProject == null)
            {
                ErrorMessage = "No active project found. Contact admin.";
                return;
            }

            using var context = DbFactory.CreateDbContext();
            
            // 1. Create the Order
            var newOrder = new AssetOrder
            {
                ClientId = CurrentUser.Id,
                ProjectId = ActiveProject.Id, 
                OrderDate = DateTime.UtcNow,
                Status = "Pending Approval",
                // Storing delivery info in a way that persists (assumes extended model or description field)
                DeliveryAddress = DeliveryAddress, 
                ContactNumber = ContactNumber,
                Items = new List<OrderItem>()
            };

            // 2. Add Items
            foreach (var cartItem in Cart)
            {
                newOrder.Items.Add(new OrderItem
                {
                    CatalogItemId = cartItem.CatalogItemId,
                    Quantity = cartItem.Quantity,
                    PriceAtOrder = cartItem.UnitCost
                });
            }

            context.AssetOrders.Add(newOrder);
            await context.SaveChangesAsync();

            // 3. Success Feedback
            Cart.Clear();
            isCartVisible = false;
            SuccessMessage = $"Order #{newOrder.Id} placed! The Logistics team will deliver to: {DeliveryAddress}";
            DeliveryAddress = ""; // Reset
            ContactNumber = "";
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to place order");
            ErrorMessage = "There was an error processing your order. Please try again.";
        }
        finally
        {
            IsSaving = false;
        }
    }

    public class CartItemViewModel
    {
        public int CatalogItemId { get; set; }
        public string ItemName { get; set; } = "";
        public string Category { get; set; } = "";
        public decimal UnitCost { get; set; }
        public int Quantity { get; set; }
        public decimal TotalCost => UnitCost * Quantity;
    }
}