@page "/admin/projects"
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations
@using ToroTrack.Components.Layout
@using ToroTrack.Business.Services
@using ToroTrack.Data
@using ToroTrack.Models
@using ToroTrack.Data.Entities

@attribute [Authorize(Roles = "Admin")]
@inject IProjectService ProjectService
@inject ILogger<Projects> Logger
@rendermode InteractiveServer

<PageTitle>Projects | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Project Management</h1>
            <p class="page-subtitle">Create and monitor client projects.</p>
        </div>

        <div class="header-center">
            <div class="search-wrapper">
                <input type="text" @bind="SearchQuery" @bind:event="oninput" placeholder="Search projects..." class="search-input" />
            </div>
        </div>

        <div class="header-right">
            <button class="btn-primary-toro" @onclick="OpenCreateModal">
                <span class="bi bi-plus-lg me-2"></span> Create Project
            </button>
        </div>
    </header>

    @* Data Grid *@
    <div class="table-container">
        <table class="toro-table project-table">
            <thead>
                <tr>
                    <th style="width: 20%">Project Name</th>
                    <th style="width: 20%">Client</th>
                    <th style="width: 12%">Start Date</th>
                    <th style="width: 12%">Due Date</th>
                    <th style="width: 13%">Current Team</th>
                    <th style="width: 10%">Progress</th>
                    <th style="width: 8%" class="text-center">Status</th>
                    <th style="width: 5%" class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
                @if (ProjectList == null)
                {
                    <tr><td colspan="8" class="text-center">Loading projects...</td></tr>
                }
                else if (!FilteredProjects.Any())
                {
                    <tr><td colspan="8" class="text-center text-muted">No projects found.</td></tr>
                }
                else
                {
                    @foreach (var project in FilteredProjects)
                    {
                        <tr class="@(project.IsActive ? "" : "row-inactive")">
                            <td class="fw-bold text-primary">@project.Name</td>
                            <td>
                                <div>@project.ClientName</div>
                                <small class="text-muted">@project.ClientEmail</small>
                            </td>
                            <td>@project.StartDate.ToString("MMM dd, yyyy")</td>
                            <td>@project.DueDate.ToString("MMM dd, yyyy")</td>
                            <td>
                                <span class="team-badge">@project.CurrentTeam</span>
                            </td>
                            <td>
                                <div class="progress-wrapper">
                                    <div class="progress-bar-bg">
                                        <div class="progress-fill" style="width: @(project.ProgressPercent)%"></div>
                                    </div>
                                    <span class="progress-text">@project.ProgressPercent%</span>
                                </div>
                            </td>
                            <td class="text-center">
                                @if (project.IsActive)
                                {
                                    <span class="status-badge active">Active</span>
                                }
                                else
                                {

                                    <span class="status-badge inactive">Suspended</span>
                                }
                            </td>
                            <td class="text-center">
                                <button class="btn-edit-custom" @onclick="() => EditProject(project)">Edit</button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

<ToroModal @bind-IsVisible="isModalVisible" Title="@modalTitle">
    <EditForm Model="InputModel" OnValidSubmit="HandleSubmit">
        <DataAnnotationsValidator />

        <div class="form-group">
            <label class="small-label">Project Name</label>
            <InputText @bind-Value="InputModel.Name" class="form-control" placeholder="e.g. Azure Migration" />
            <ValidationMessage For="@(() => InputModel.Name)" class="text-danger" />
        </div>

        <div class="form-group">
            <label class="small-label">Client</label>
            @if (isEditing)
            {
                <input type="text" class="form-control" value="@GetClientNameById(InputModel.SelectedClientId)" disabled />
                <input type="hidden" @bind="InputModel.SelectedClientId" />
            }
            else
            {
                <InputSelect @bind-Value="InputModel.SelectedClientId" class="form-select form-control">
                    <option value="">Select Invited Client</option>
                    @if (ActiveClients != null)
                    {
                        @foreach (var client in ActiveClients)
                        {
                            <option value="@client.Id">@client.FirstName @client.LastName (@client.Email)</option>
                        }
                    }
                </InputSelect>
                <ValidationMessage For="@(() => InputModel.SelectedClientId)" class="text-danger" />
            }
        </div>

        <div class="form-group">
            <label class="small-label">Assigned Team</label>
            <InputSelect @bind-Value="InputModel.AssignedTeam" class="form-select form-control">
                <option value="Platform Engineer">Platform Engineer (Hardware/Infrastructure)</option>
                <option value="Logistics Coordinator">Logistics Coordinator (Procurement)</option>
                <option value="Network Security Engineer">Network Security Engineer (VPN/Firewall)</option>
                <option value="Cloud Engineer">Cloud Engineer (Migration/Backup)</option>
                <option value="Modern Workplace Engineer">Modern Workplace Engineer (O365)</option>
            </InputSelect>
            <ValidationMessage For="@(() => InputModel.AssignedTeam)" class="text-danger" />
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <label class="small-label">Start Date</label>
                    <InputDate @bind-Value="InputModel.StartDate" class="form-control" />
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-group">
                    <label class="small-label">Due Date</label>
                    <InputDate @bind-Value="InputModel.DueDate" class="form-control" min="@InputModel.StartDate.ToString("yyyy-MM-dd")" />
                </div>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(ErrorMessage))
        {
            <div class="alert alert-danger mt-3">@ErrorMessage</div>
        }

        <div class="form-actions mt-4 text-end">
            <button type="submit" class="btn-primary-toro" disabled="@isSaving">
                @if (isSaving)
                {
                    <span>Saving...</span>
                }
                else
                {

                    <span>@(isEditing ? "Save Changes" : "Initialize Project")</span>
                }
            </button>
        </div>
    </EditForm>
</ToroModal>

@code {
    private bool isModalVisible = false;
    private bool isEditing = false;
    private bool isSaving = false;
    private string modalTitle = "";
    private string SearchQuery { get; set; } = "";
    private string? ErrorMessage { get; set; }
    private List<ProjectViewModel>? ProjectList;
    private List<ApplicationUser>? ActiveClients;

    [SupplyParameterFromForm]
    private ProjectInputModel InputModel { get; set; } = new();

    protected override async Task OnInitializedAsync() => await LoadDataAsync();

    private async Task LoadDataAsync()
    {
        try
        {
            var projectsTask = ProjectService.GetAllProjectsAsync();
            var clientsTask = ProjectService.GetActiveClientsAsync();
            await Task.WhenAll(projectsTask, clientsTask);
            ProjectList = projectsTask.Result;
            ActiveClients = clientsTask.Result;
        }
        catch (Exception ex) { Logger.LogError(ex, "Failed to load project data"); }
    }

    private IEnumerable<ProjectViewModel> FilteredProjects =>
        string.IsNullOrWhiteSpace(SearchQuery) || ProjectList == null
        ? (ProjectList ?? new List<ProjectViewModel>())
        : ProjectList.Where(p => p.Name.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) || p.ClientName.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase));

    private void OpenCreateModal()
    {
        isEditing = false;
        ErrorMessage = null;
        modalTitle = "Initialize New Project";
        InputModel = new ProjectInputModel
        {
            AssignedTeam = "Platform Engineer",
            StartDate = DateTime.Now,
            DueDate = DateTime.Now.AddMonths(1)
        };
        isModalVisible = true;
    }

    private void EditProject(ProjectViewModel project)
    {
        isEditing = true;
        ErrorMessage = null;
        modalTitle = "Edit Project Details";
        var matchedClient = ActiveClients?.FirstOrDefault(c => c.Email == project.ClientEmail);
        InputModel = new ProjectInputModel
        {
            Id = project.Id,
            Name = project.Name,
            SelectedClientId = matchedClient?.Id ?? "",
            AssignedTeam = project.CurrentTeam,
            StartDate = project.StartDate,
            DueDate = project.DueDate
        };
        isModalVisible = true;
    }

    private async Task HandleSubmit()
    {
        isSaving = true;
        try
        {
            InputModel.StartDate = DateTime.SpecifyKind(InputModel.StartDate, DateTimeKind.Utc);
            InputModel.DueDate = DateTime.SpecifyKind(InputModel.DueDate, DateTimeKind.Utc);

            if (isEditing) await ProjectService.UpdateProjectAsync(InputModel);
            else await ProjectService.CreateProjectAsync(InputModel);

            isModalVisible = false;
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Database Error: {ex.Message}";
        }
        finally { isSaving = false; }
    }

    private string GetClientNameById(string id)
    {
        var c = ActiveClients?.FirstOrDefault(u => u.Id == id);
        return c != null ? $"{c.FirstName} {c.LastName}" : "Unknown";
    }
}