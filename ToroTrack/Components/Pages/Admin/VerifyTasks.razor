@page "/admin/verify"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Text.RegularExpressions
@using ToroTrack.Components.Layout
@using ToroTrack.Data
@using ToroTrack.Data.Entities

@* Security: Only Admins should see this page *@
@attribute [Authorize(Roles = "Admin")]
@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ILogger<VerifyTasks> Logger
@rendermode InteractiveServer

<PageTitle>Verify Tasks | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Task Verification</h1>
            <p class="page-subtitle">Review and approve completed team tasks.</p>
        </div>
        <div class="header-center">
            <div class="search-wrapper">
                <input type="text" @bind="SearchQuery" @bind:event="oninput" placeholder="Search by task or team..." class="search-input" />
            </div>
        </div>
        <div class="header-right"></div>
    </header>

    @* --- SNACKBAR NOTIFICATIONS --- *@
    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="toro-snackbar success">
            <i class="bi bi-check-circle-fill snackbar-icon"></i>
            <span class="snackbar-text">@SuccessMessage</span>
            <button class="snackbar-close" @onclick='() => SuccessMessage = ""'>
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    }
    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="toro-snackbar error">
            <i class="bi bi-exclamation-triangle-fill snackbar-icon"></i>
            <span class="snackbar-text">@ErrorMessage</span>
            <button class="snackbar-close" @onclick='() => ErrorMessage = ""'>
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    }

    <div class="table-container">
        <table class="toro-table">
            <thead>
                <tr>
                    <th style="width: 20%">Task Name</th>
                    <th style="width: 15%">Project</th>
                    <th style="width: 15%">Assigned Team</th>
                    <th style="width: 15%">Due Date</th>
                    <th style="width: 10%" class="text-center">Evidence</th>
                    <th style="width: 25%" class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (IsLoading)
                {
                    <tr><td colspan="6" class="text-center py-5 text-muted">Loading pending tasks...</td></tr>
                }
                else if (!FilteredTasks.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">No tasks pending verification.</td>
                    </tr>
                }
                else
                {
                    @foreach (var task in FilteredTasks)
                    {
                        var lockInfo = GetStageLockStatus(task);

                        <tr style="@(lockInfo.IsLocked ? "background-color: rgba(0,0,0,0.02);" : "")">
                            <td>
                                <div class="fw-bold @(lockInfo.IsLocked ? "text-muted" : "")">@task.Title</div>
                                <small class="text-muted">@Truncate(task.Description, 50)</small>
                            </td>
                            <td>
                                @(task.Project?.Name ?? "Unknown Project")
                            </td>
                            <td><span class="team-badge">@task.AssignedToId</span></td>
                            <td>
                                @(task.DueDate.HasValue? task.DueDate.Value.ToString("MMM dd, yyyy") : "N/A")
                            </td>
                            <td class="text-center">
                                @if (!string.IsNullOrEmpty(task.ProofUrl))
                                {
                                    <button class="btn-view-proof" @onclick="() => ViewProof(task)">
                                        <span class="bi bi-eye-fill"></span> View
                                    </button>
                                }
                                else
                                {
                                    <span class="text-muted small">None</span>
                                }
                            </td>
                            <td class="text-center">
                                @if (lockInfo.IsLocked)
                                {
                                    <div class="d-flex gap-2 justify-content-center align-items-center text-muted" title="@lockInfo.Reason">
                                        <i class="bi bi-lock-fill text-warning"></i>
                                        <span class="small fw-bold" style="font-size: 0.75rem;">LOCKED</span>
                                    </div>
                                    <div class="small text-muted fst-italic mt-1" style="font-size: 0.65rem;">
                                        @lockInfo.Reason
                                    </div>
                                }
                                else
                                {
                                    <div class="d-flex gap-2 justify-content-center">
                                        <button class="btn-approve" @onclick="() => ProcessTaskDecision(task, true)">
                                            <span class="bi bi-check-lg"></span> Approve
                                        </button>
                                        <button class="btn-reject" @onclick="() => ProcessTaskDecision(task, false)">
                                            <span class="bi bi-x-lg"></span> Reject
                                        </button>
                                    </div>
                                }
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@* ADMIN VIEW PROOF MODAL *@
<ToroModal @bind-IsVisible="isProofVisible" Title="Proof of Completion">
    @if (SelectedTask != null)
    {
        <div class="p-3">
            <div class="mb-4">
                <label class="small-label">Task Details</label>
                <p class="fw-bold mb-1">@SelectedTask.Title</p>
                <p class="text-muted small">@SelectedTask.Description</p>
            </div>

            <div class="mb-3">
                <label class="small-label">Attached Evidence</label>

                @if (string.IsNullOrEmpty(SelectedTask.ProofUrl))
                {
                    <p class="text-danger">No evidence attached.</p>
                }
                else if (IsUrl(SelectedTask.ProofUrl))
                {
                    <a href="@SelectedTask.ProofUrl" target="_blank" class="d-block p-2 mb-2 border rounded bg-white text-primary text-decoration-underline">
                        <span class="bi bi-link-45deg me-2"></span> @SelectedTask.ProofUrl
                    </a>
                }
                else
                {
                    <div class="d-flex align-items-center justify-content-between p-2 border rounded bg-white">
                        <div class="d-flex align-items-center gap-2">
                            <span class="bi bi-file-earmark-text text-success fs-5"></span>
                            <span class="fw-bold" style="font-size: 0.9rem;">@SelectedTask.ProofUrl</span>
                        </div>
                        <button class="btn btn-sm btn-outline-dark" style="font-size: 0.75rem;">
                            <span class="bi bi-download"></span> Download
                        </button>
                    </div>
                }
            </div>
        </div>
    }
</ToroModal>

@code {
    // --- State Management ---
    private List<ProjectTask> PendingTasks = new();
    private ProjectTask? SelectedTask;
    private bool isProofVisible = false;
    private bool IsLoading = true;
    private string SearchQuery { get; set; } = "";

    // --- Feedback Messages ---
    private string SuccessMessage = "";
    private string ErrorMessage = "";

    // --- Data Loading ---
    protected override async Task OnInitializedAsync()
    {
        await LoadPendingTasksAsync();
    }

    private async Task LoadPendingTasksAsync()
    {
        try
        {
            IsLoading = true;
            using var context = DbFactory.CreateDbContext();

            // fetch tasks waiting for review AND include sibling tasks (Project.Tasks) to check dependencies
            PendingTasks = await context.ProjectTasks
                .Include(t => t.Project)
                    .ThenInclude(p => p.Tasks)
                .Where(t => t.Status == "PendingReview")
                .OrderByDescending(t => t.DueDate)
                .ToListAsync();

            Logger.LogInformation("Loaded {Count} pending verification tasks", PendingTasks.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load pending tasks");
            ErrorMessage = "Unable to load tasks from database.";
        }
        finally
        {
            IsLoading = false;
        }
    }

    // --- Search Filtering ---
    private IEnumerable<ProjectTask> FilteredTasks =>
        string.IsNullOrWhiteSpace(SearchQuery)
        ? PendingTasks
        : PendingTasks.Where(t =>
            (t.Title?.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (t.AssignedToId?.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (t.Project?.Name?.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ?? false));

    // --- Dependency Logic ---
    private (bool IsLocked, string Reason) GetStageLockStatus(ProjectTask task)
    {
        // 1. Check if this is a "Stage X" task
        var match = Regex.Match(task.Title ?? "", @"^Stage (\d+):");
        if (match.Success && int.TryParse(match.Groups[1].Value, out int currentStage))
        {
            // 2. Logic: If Stage > 1, check if Stage (X-1) is Verified
            if (currentStage > 1)
            {
                int prevStageNum = currentStage - 1;

                // Find the previous stage in the SAME project
                var prevTask = task.Project?.Tasks?
                    .FirstOrDefault(t => t.Title.StartsWith($"Stage {prevStageNum}:"));

                if (prevTask == null)
                {
                    // If previous stage doesn't exist, technically it's an error, or we default to locked
                    return (true, $"Stage {prevStageNum} is missing.");
                }

                if (prevTask.Status != "Verified")
                {
                    return (true, $"Must verify 'Stage {prevStageNum}' first.");
                }
            }
        }

        return (false, "");
    }

    // --- User Actions ---
    private void ViewProof(ProjectTask task)
    {
        SelectedTask = task;
        isProofVisible = true;
    }

    private async Task ProcessTaskDecision(ProjectTask task, bool isApproved)
    {
        try
        {
            using var context = DbFactory.CreateDbContext();

            // Re-fetch to ensure we have the latest state before modifying
            var dbTask = await context.ProjectTasks.FindAsync(task.Id);

            if (dbTask == null)
            {
                ErrorMessage = "Task not found. It may have been deleted.";
                await LoadPendingTasksAsync();
                return;
            }

            // Apply Logic: Approve -> Verified | Reject -> Doing (Send back to team)
            dbTask.Status = isApproved ? "Verified" : "Doing";

            await context.SaveChangesAsync();

            // UI Feedback
            var actionWord = isApproved ? "approved" : "rejected";
            SuccessMessage = $"Task '{dbTask.Title}' has been {actionWord}.";

            // Refresh List
            await LoadPendingTasksAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error processing task decision for TaskId {Id}", task.Id);
            ErrorMessage = "An error occurred while updating the task.";
        }
    }

    // --- Helpers ---
    private string Truncate(string value, int maxLen)
    {
        if (string.IsNullOrEmpty(value)) return "";
        return value.Length <= maxLen ? value : value.Substring(0, maxLen) + "...";
    }

    private bool IsUrl(string value)
    {
        return Uri.TryCreate(value, UriKind.Absolute, out var result)
               && (result.Scheme == Uri.UriSchemeHttp || result.Scheme == Uri.UriSchemeHttps);
    }
}