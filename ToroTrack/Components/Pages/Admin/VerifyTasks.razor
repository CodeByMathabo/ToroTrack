@page "/admin/verify"
@using Microsoft.AspNetCore.Authorization
@using ToroTrack.Components.Layout
@*attribute [Authorize(Roles = "Admin")]*@
@rendermode InteractiveServer

<PageTitle>Verify Tasks | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Task Verification</h1>
            <p class="page-subtitle">Review and approve completed team tasks.</p>
        </div>
        <div class="header-center">
            <div class="search-wrapper">
                <input type="text" placeholder="Search by task or team..." class="search-input" />
            </div>
        </div>
        <div class="header-right"></div>
    </header>

    <div class="table-container">
        <table class="toro-table">
            <thead>
                <tr>
                    <th style="width: 20%">Task Name</th>
                    <th style="width: 15%">Project</th>
                    <th style="width: 15%">Assigned Team</th>
                    <th style="width: 15%">Completion Date</th>
                    <th style="width: 10%" class="text-center">Evidence</th>
                    <th style="width: 25%" class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (!PendingVerifications.Any())
                {
                    <tr>
                        <td colspan="6" class="text-center py-5 text-muted">No tasks pending verification.</td>
                    </tr>
                }
                else
                {
                    @foreach (var task in PendingVerifications)
                    {
                        <tr>
                            <td>
                                <div class="fw-bold">@task.Title</div>
                                <small class="text-muted">@task.Description</small>
                            </td>
                            <td>@task.ProjectName</td>
                            <td><span class="team-badge">@task.TeamName</span></td>
                            <td>@task.CompletedDate.ToString("MMM dd, HH:mm")</td>
                            <td class="text-center">
                                <button class="btn-view-proof" @onclick="() => ViewProof(task)">
                                    <span class="bi bi-eye-fill"></span> View
                                </button>
                            </td>
                            <td class="text-center">
                                <div class="d-flex gap-2 justify-content-center">
                                    <button class="btn-approve" @onclick="() => ApproveTask(task)">
                                        <span class="bi bi-check-lg"></span> Approve
                                    </button>
                                    <button class="btn-reject" @onclick="() => RejectTask(task)">
                                        <span class="bi bi-x-lg"></span> Reject
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@* ADMIN VIEW PROOF MODAL *@
<ToroModal @bind-IsVisible="isProofVisible" Title="Proof of Completion">
    @if (SelectedTask != null)
    {
        <div class="p-3">
            <div class="mb-4">
                <label class="small-label">Task</label>
                <p class="fw-bold">@SelectedTask.Title</p>
            </div>

            <div class="mb-4">
                <label class="small-label">Team Notes</label>
                <div class="p-3 bg-light rounded border">
                    @if (string.IsNullOrEmpty(SelectedTask.ProofNotes))
                    {
                        <em class="text-muted">No notes provided.</em>
                    }
                    else
                    {
                        @SelectedTask.ProofNotes
                    }
                </div>
            </div>

            <div class="mb-3">
                <label class="small-label">Attached Evidence</label>

                @if (string.IsNullOrEmpty(SelectedTask.ProofLink) && string.IsNullOrEmpty(SelectedTask.ProofFileName))
                {
                    <p class="text-danger">No evidence attached.</p>
                }

                @* 1. Show Link if exists *@
                @if (!string.IsNullOrEmpty(SelectedTask.ProofLink))
                {
                    <a href="@SelectedTask.ProofLink" target="_blank" class="d-block p-2 mb-2 border rounded bg-white text-primary text-decoration-underline">
                        <span class="bi bi-link-45deg me-2"></span> @SelectedTask.ProofLink
                    </a>
                }

                @* 2. Show File if exists (This will stack below the link if both exist) *@
                @if (!string.IsNullOrEmpty(SelectedTask.ProofFileName))
                {
                    <div class="d-flex align-items-center justify-content-between p-2 border rounded bg-white">
                        <div class="d-flex align-items-center gap-2">
                            <span class="bi bi-file-earmark-text text-success fs-5"></span>
                            <span class="fw-bold" style="font-size: 0.9rem;">@SelectedTask.ProofFileName</span>
                        </div>
                        <button class="btn btn-sm btn-outline-dark" style="font-size: 0.75rem;">
                            <span class="bi bi-download"></span> Download
                        </button>
                    </div>
                }
            </div>
        </div>
    }
</ToroModal>

@code {
    public class VerificationItem
    {
        public int Id { get; set; }
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
        public string ProjectName { get; set; } = "";
        public string TeamName { get; set; } = "";
        public DateTime CompletedDate { get; set; }

        // Proof Data
        public string ProofLink { get; set; } = "";
        public string ProofFileName { get; set; } = "";
        public string ProofNotes { get; set; } = "";
    }

    private bool isProofVisible = false;
    private VerificationItem? SelectedTask;

    private List<VerificationItem> PendingVerifications = new()
    {
        // Case 1: Only Link
        new VerificationItem { Id = 1, Title = "Configure VPN Access", ProjectName = "Law Firm Z", TeamName = "Network & Security", CompletedDate = DateTime.Now.AddHours(-2), ProofLink = "https://github.com/torotrack/vpn-configs", ProofNotes = "Configured OpenVPN on Server 2." },

        // Case 2: Only File
        new VerificationItem { Id = 2, Title = "Setup O365 Tenants", ProjectName = "Retail Corp", TeamName = "Modern Workplace", CompletedDate = DateTime.Now.AddMinutes(-45), ProofFileName = "Tenant_Config_Log.csv", ProofNotes = "Tenants created. Log file attached." },

        // Case 3: BOTH Link and File
        new VerificationItem { Id = 3, Title = "Database Migration", ProjectName = "Logistics Co", TeamName = "Cloud Migration", CompletedDate = DateTime.Now.AddMinutes(-10), ProofLink = "https://azure.microsoft.com/migration-report/123", ProofFileName = "Migration_Errors.pdf", ProofNotes = "Migration complete. See Azure link for status and PDF for error log." }
    };

    private void ViewProof(VerificationItem task)
    {
        SelectedTask = task;
        isProofVisible = true;
    }

    private void ApproveTask(VerificationItem task)
    {
        PendingVerifications.Remove(task);
    }

    private void RejectTask(VerificationItem task)
    {
        PendingVerifications.Remove(task);
    }
}