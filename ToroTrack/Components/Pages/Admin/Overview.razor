@page "/admin/overview"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using ToroTrack.Components.Layout
@using ToroTrack.Data
@using ToroTrack.Data.Entities

@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject UserManager<ApplicationUser> UserManager
@inject ILogger<Overview> Logger

<PageTitle>Overview | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div>
            <h1 class="page-title">Dashboard Overview</h1>
            <p class="page-subtitle">Real-time system metrics and pending client requests.</p>
        </div>
    </header>

    @* --- STATISTICS CARDS --- *@
    <div class="stats-container">
        <div class="stat-card">
            <span class="stat-title">Total Clients</span>
            <span class="stat-number">@Stats.TotalClients</span>
        </div>
        <div class="stat-card">
            <span class="stat-title">Active Projects</span>
            <span class="stat-number">@Stats.ActiveProjects</span>
        </div>
        @* Why: This card now reflects real entries from the ClientAssets table *@
        <div class="stat-card">
            <span class="stat-title">Delivered Assets</span>
            <span class="stat-number">@Stats.DeliveredAssets</span>
        </div>
    </div>

    @* --- PENDING ITEMS FEED --- *@
    <div class="section-wrapper">
        <h3 class="section-title">Pending Client Attention</h3>
        <p class="text-muted mb-4">Recent tasks or queries submitted by clients requiring your attention.</p>

        <div class="queries-grid">
            @if (IsLoading)
            {
                <div class="p-4 text-muted fst-italic">Loading pending items...</div>
            }
            else if (!PendingQueries.Any())
            {
                <div class="p-4 text-success border rounded bg-light">
                    <span class="bi bi-check-circle-fill me-2"></span> All caught up! No pending items.
                </div>
            }
            else
            {
                @foreach (var query in PendingQueries)
                {
                    <div class="query-card">
                        <div class="query-header">
                            <span class="client-badge">@query.ClientName</span>
                            <span class="date-badge">@query.DateSubmitted</span>
                        </div>
                        <h4 class="query-subject">@query.Subject</h4>
                        <p class="query-preview">@query.PreviewText</p>
                        <div class="query-actions">
                            <button class="btn-reply-toro" @onclick="() => OpenReplyModal(query)">
                                <span class="bi bi-reply-fill me-2"></span> Review
                            </button>
                        </div>
                    </div>
                }
            }
        </div>
    </div>

    @* --- ACTION BUTTONS --- *@
    <div class="actions-row mt-5">
        <button class="action-btn-card" @onclick="() => ShowModal(ModalType.Licenses)">
            <span class="bi bi-card-checklist d-block mb-2 fs-3"></span>
            Expiring Licenses
        </button>

        <button class="action-btn-card" @onclick="() => ShowModal(ModalType.Meetings)">
            <span class="bi bi-calendar-week d-block mb-2 fs-3"></span>
            Scheduled Meetings
        </button>

        <button class="action-btn-card" @onclick="() => ShowModal(ModalType.Users)">
            <span class="bi bi-people-fill d-block mb-2 fs-3"></span>
            Internal Users
        </button>
    </div>
</div>

@* --- SNACKBAR NOTIFICATION --- *@
@if (showSnackbar)
{
    <div class="toro-snackbar @snackbarType">
        <span class="@snackbarIcon me-2"></span> @snackbarMessage
    </div>
}

@* --- MODALS --- *@
<ToroModal @bind-IsVisible="isModalVisible" Title="@modalTitle">
    @if (currentModal == ModalType.ReplyQuery && selectedQuery != null)
    {
        <div class="reply-context">
            <label class="small-label">Item Context:</label>
            <p class="p-3 bg-light rounded">@selectedQuery.PreviewText</p>
        </div>
        <div class="form-group mt-3">
            <label class="small-label">Quick Response / Note:</label>
            <textarea class="form-control mt-1" rows="5" placeholder="Type your resolution here..."></textarea>
        </div>
        <div class="mt-3 text-end">
            <button class="btn-primary-toro" @onclick="MarkQueryResolved">
                <span class="bi bi-send-fill me-2"></span> Mark Resolved
            </button>
        </div>
    }
    @* Kept other modal contents (Licenses, Meetings, Users) as per original layout *@
    else if (currentModal == ModalType.Licenses)
    {
        <table class="toro-table">
            <thead>
                <tr>
                    <th style="width: 35%">Client</th>
                    <th style="width: 35%">License Type</th>
                    <th style="width: 30%; text-align: center;">Expiry Date</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Toro Info</strong></td>
                    <td>Azure AD Premium P1</td>
                    <td class="text-danger text-center">Oct 30, 2025</td>
                </tr>
            </tbody>
        </table>
    }
    else if (currentModal == ModalType.Meetings)
    {
        <table class="toro-table">
            <thead>
                <tr>
                    <th style="width: 25%">Date & Time</th>
                    <th style="width: 20%">Client</th>
                    <th style="width: 20%">Title</th>
                    <th style="width: 35%">Description</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var meeting in UpcomingMeetings)
                {
                    <tr>
                        <td style="white-space: nowrap;">@meeting.Date</td>
                        <td><span class="client-badge" style="font-size: 0.7rem;">@meeting.ClientName</span></td>
                        <td><strong>@meeting.Title</strong></td>
                        <td class="text-muted" style="font-size: 0.9rem;">@meeting.Description</td>
                    </tr>
                }
            </tbody>
        </table>
    }
    else if (currentModal == ModalType.Users)
    {
        <table class="toro-table">
            <thead>
                <tr>
                    <th style="width: 40%">User Name</th>
                    <th style="width: 30%">Email</th>
                    <th style="width: 30%; text-align: center;">Status</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var user in InternalUsers)
                {
                    <tr>
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                <div class="rounded-circle bg-success" style="width: 8px; height: 8px;"></div>
                                @user.UserName
                            </div>
                        </td>
                        <td>@user.Email</td>
                        <td class="text-success text-center">Active</td>
                    </tr>
                }
            </tbody>
        </table>
    }
</ToroModal>

@code {
    // --- MODELS ---
    public class DashboardStats
    {
        public int TotalClients { get; set; }
        public int ActiveProjects { get; set; }
        public int DeliveredAssets { get; set; }
    }

    public class ClientQuery
    {
        public int Id { get; set; }
        public string ClientName { get; set; } = "";
        public string Subject { get; set; } = "";
        public string PreviewText { get; set; } = "";
        public string DateSubmitted { get; set; } = "";
    }

    public class MeetingDTO
    {
        public string Date { get; set; } = "";
        public string ClientName { get; set; } = "";
        public string Title { get; set; } = "";
        public string Description { get; set; } = "";
    }

    public class InternalUserViewModel
    {
        public string UserName { get; set; } = "";
        public string Email { get; set; } = "";
    }

    // --- STATE ---
    private DashboardStats Stats = new();
    private List<ClientQuery> PendingQueries = new();
    private List<MeetingDTO> UpcomingMeetings = new();
    private List<InternalUserViewModel> InternalUsers = new();

    private bool isModalVisible = false;
    private bool IsLoading = true;
    private string modalTitle = "";
    private ModalType currentModal;
    private ClientQuery? selectedQuery;

    private bool showSnackbar = false;
    private string snackbarMessage = "";
    private string snackbarType = "success";
    private string snackbarIcon = "bi-check-circle-fill";

    private enum ModalType { Licenses, Meetings, Users, ReplyQuery }

    protected override async Task OnInitializedAsync()
    {
        Logger.LogInformation("Initializing Dashboard...");
        try
        {
            IsLoading = true;
            using var context = DbFactory.CreateDbContext();

            // Why: Break down logic into small, readable methods [cite: 9]
            await LoadStatsAsync(context);
            await LoadPendingQueriesAsync(context);
            await LoadUpcomingMeetingsAsync(context);
            await LoadInternalUsersAsync();
        }
        catch (Exception ex)
        {
            // Why: Catch failures early to prevent page crash [cite: 13]
            Logger.LogError(ex, "Critical failure loading dashboard data");
            await ShowSnackbar("Failed to load dashboard data", "error");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadStatsAsync(ApplicationDbContext context)
    {
        try
        {
            // Why: Get active clients using UserManager
            var clients = await UserManager.GetUsersInRoleAsync("Client");
            Stats.TotalClients = clients.Count;

            // Why: Efficiently count projects without loading entities
            Stats.ActiveProjects = await context.Projects.CountAsync(p => p.Status == "Active");

            // Why: Ensure this reflects real data from the SignOff process
            Stats.DeliveredAssets = await context.ClientAssets.CountAsync();

            Logger.LogInformation($"Stats Loaded - Clients: {Stats.TotalClients}, Projects: {Stats.ActiveProjects}, Assets: {Stats.DeliveredAssets}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading stats");
            // Why: Reset to 0 on error so UI looks clean
            Stats = new DashboardStats();
        }
    }

    private async Task LoadPendingQueriesAsync(ApplicationDbContext context)
    {
        // Why: Fetch tasks needing review. Assuming 'PendingReview' or 'Done' waiting for admin checks.
        var pendingTasks = await context.ProjectTasks
            .Include(t => t.Project)
                .ThenInclude(p => p.Client)
            .Where(t => t.Status == "PendingReview")
            .OrderByDescending(t => t.CompletedDate)
            .Take(10)
            .ToListAsync();

        Logger.LogInformation($"Found {pendingTasks.Count} pending tasks.");

        PendingQueries = pendingTasks.Select(t => new ClientQuery
        {
            Id = t.Id,
            ClientName = t.Project?.Client != null
                ? $"{t.Project.Client.FirstName} {t.Project.Client.LastName}"
                : (t.Project?.Name ?? "Unknown"),
            Subject = t.Title,
            PreviewText = t.Description,
            DateSubmitted = t.CompletedDate.HasValue
                ? GetTimeAgo(t.CompletedDate.Value)
                : "Recently"
        }).ToList();
    }

    private async Task LoadUpcomingMeetingsAsync(ApplicationDbContext context)
    {
        var realMeetings = await context.Meetings
            .Include(m => m.Client)
            .Where(m => m.Date >= DateTime.UtcNow.AddDays(-1))
            .OrderBy(m => m.Date)
            .ToListAsync();

        UpcomingMeetings = realMeetings.Select(m => new MeetingDTO
        {
            Date = m.Date.ToString("MMM dd, HH:mm"),
            ClientName = m.Client != null ? $"{m.Client.FirstName} {m.Client.LastName}" : "Unknown",
            Title = m.Title,
            Description = m.Description
        }).ToList();
    }

    private async Task LoadInternalUsersAsync()
    {
        // Why: Separate user fetching logic to keep main flow clean
        var clients = await UserManager.GetUsersInRoleAsync("Client");
        var allUsers = await UserManager.Users.ToListAsync();

        var clientIds = clients.Select(c => c.Id).ToHashSet();

        InternalUsers = allUsers
            .Where(u => !clientIds.Contains(u.Id))
            .Select(u => new InternalUserViewModel
            {
                UserName = $"{u.FirstName} {u.LastName}",
                Email = u.Email ?? ""
            })
            .ToList();
    }

    // --- UI HELPERS ---

    private void ShowModal(ModalType type)
    {
        currentModal = type;
        selectedQuery = null;
        isModalVisible = true;
        modalTitle = type.ToString();
    }

    private void OpenReplyModal(ClientQuery query)
    {
        currentModal = ModalType.ReplyQuery;
        selectedQuery = query;
        modalTitle = $"Reviewing item for {query.ClientName}";
        isModalVisible = true;
    }

    private async Task MarkQueryResolved()
    {
        if (selectedQuery == null) return;

        try
        {
            using var context = DbFactory.CreateDbContext();
            var task = await context.ProjectTasks.FindAsync(selectedQuery.Id);

            if (task != null)
            {
                task.Status = "Done";
                await context.SaveChangesAsync();
                Logger.LogInformation($"Task {task.Id} marked resolved by admin.");

                await ShowSnackbar("Item marked as resolved.", "success");
                isModalVisible = false;

                // Why: Refresh data to remove the resolved item from list
                await OnInitializedAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to resolve item");
            await ShowSnackbar("Error updating item.", "error");
        }
    }

    private async Task ShowSnackbar(string message, string type)
    {
        snackbarMessage = message;
        snackbarType = type == "success" ? "snackbar-success" : "snackbar-error";
        snackbarIcon = type == "success" ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill";
        showSnackbar = true;
        StateHasChanged();
        await Task.Delay(3000);
        showSnackbar = false;
        StateHasChanged();
    }

    private string GetTimeAgo(DateTime date)
    {
        var span = DateTime.UtcNow - date;
        if (span.TotalHours < 1) return $"{Math.Max(1, (int)span.TotalMinutes)} min ago";
        if (span.TotalHours < 24) return $"{(int)span.TotalHours} hrs ago";
        return $"{(int)span.TotalDays} days ago";
    }
}