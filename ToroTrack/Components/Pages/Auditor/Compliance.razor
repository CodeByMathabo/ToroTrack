@page "/auditor/compliance"
@using Microsoft.AspNetCore.Authorization
@using ToroTrack.Components.Layout
@* attribute [Authorize(Roles = "Auditor")] *@
@rendermode InteractiveServer
@inject ILogger<Compliance> Logger

<PageTitle>Compliance Intelligence | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Compliance Intelligence</h1>
            <p class="page-subtitle">Automated system health checks and risk detection.</p>
        </div>
        <div class="header-right">
            <button class="btn-primary-toro" @onclick="RunAutoAudit" disabled="@isScanning">
                @if (isScanning)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span> <span>Scanning Ecosystem...</span>
                }
                else
                {
                    <span class="bi bi-arrow-repeat me-2"></span> <span>Run Auto-Audit</span>
                }
            </button>
        </div>
    </header>

    @* METRICS ROW *@
    <div class="stats-container">
        @* Compliance Score Card *@
        <div class="stat-card @GetScoreClass(ComplianceScore)">
            <span class="stat-title">System Compliance Score</span>
            <div class="d-flex align-items-baseline gap-2">
                <span class="stat-number">@ComplianceScore%</span>
                <span class="stat-trend">
                    @if (ComplianceScore < 90) { <span class="bi bi-arrow-down-right"></span> }
                    else { <span class="bi bi-arrow-up-right"></span> }
                </span>
            </div>
            <small class="text-muted mt-2">Calculated via 3 Real-time Rules</small>
        </div>

        @* Critical Risks Card *@
        <div class="stat-card">
            <span class="stat-title text-danger">Critical Risks</span>
            <span class="stat-number text-danger">@AuditFlags.Count(x => x.Severity == "Critical")</span>
            <small class="text-muted mt-2">Requires immediate attention</small>
        </div>

        @* Process Gaps Card *@
        <div class="stat-card">
            <span class="stat-title">Process Gaps</span>
            <span class="stat-number">@AuditFlags.Count(x => x.Category == "Process")</span>
            <small class="text-muted mt-2">Tasks missing proof of work</small>
        </div>
    </div>

    @* AUDIT REPORT TABLE *@
    <div class="audit-section mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="section-title">Live Risk Detected</h3>
            <div class="filter-badges">
                <span class="badge bg-light text-dark border">All (@AuditFlags.Count)</span>
                <span class="badge bg-danger-subtle text-danger border-danger">Critical (@AuditFlags.Count(x => x.Severity == "Critical"))</span>
            </div>
        </div>

        <div class="table-container">
            <table class="toro-table">
                <thead>
                    <tr>
                        <th style="width: 10%">Severity</th>
                        <th style="width: 15%">Category</th>
                        <th style="width: 40%">Issue Detected</th>
                        <th style="width: 20%">Entity Affected</th>
                        <th style="width: 15%" class="text-center">Auto-Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (AuditFlags.Any())
                    {
                        @foreach (var flag in AuditFlags.OrderByDescending(f => f.Severity))
                        {
                            <tr class="animate-fade-in">
                                <td>
                                    <span class="severity-pill @flag.Severity.ToLower()">@flag.Severity</span>
                                </td>
                                <td class="fw-bold text-muted">@flag.Category</td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        @if (flag.Category == "Licensing") { <span class="bi bi-credit-card-2-front text-warning"></span> }
                                        else if (flag.Category == "Security") { <span class="bi bi-shield-exclamation text-danger"></span> }
                                        else { <span class="bi bi-list-check text-primary"></span> }
                                        @flag.Message
                                    </div>
                                </td>
                                <td>@flag.EntityName</td>
                                
                                @* --- SMART ACTION COLUMN (UPDATED) --- *@
                                <td class="text-center">
                                    @if (flag.Category == "Licensing")
                                    {
                                        @* Action: Go to License Page to update the expiry date *@
                                        <a href="auditor/license" class="btn-action-sm btn-action-license">
                                            <span class="bi bi-pencil-square"></span> Renew / Edit
                                        </a>
                                    }
                                    else if (flag.Category == "Process")
                                    {
                                        @* Action: Email the specific Team Lead to upload proof *@
                                        <button class="btn-action-sm btn-action-process" @onclick="() => PingTeamLead(flag)">
                                            <span class="bi bi-bell-fill"></span> Ping Team
                                        </button>
                                    }
                                    else if (flag.Category == "Security")
                                    {
                                         @* Action: Security risks MUST go to Admin immediately *@
                                        <button class="btn-action-sm btn-action-security" @onclick="() => NotifyAdmin(flag)">
                                            <span class="bi bi-shield-lock-fill"></span> Alert Admin
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn-action-sm" @onclick="() => ResolveFlag(flag)">
                                            <span class="bi bi-check2"></span> Resolve
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <span class="bi bi-shield-check display-1 d-block mb-3 text-success" style="opacity: 0.5"></span>
                                System is fully compliant. No risks detected.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    // --- STATE MANAGEMENT ---
    private bool isScanning = false;
    private int ComplianceScore = 100;
    private List<AuditFlag> AuditFlags = new();

    // --- MODELS ---
    public class AuditFlag
    {
        public string Id { get; set; } = Guid.NewGuid().ToString();
        public string Severity { get; set; } = "Low"; // Critical, Warning, Low
        public string Category { get; set; } = ""; // Licensing, Process, Security
        public string Message { get; set; } = "";
        public string EntityName { get; set; } = ""; // Who/What is affected
    }

    // --- INITIALIZATION ---
    protected override async Task OnInitializedAsync()
    {
        // Why: Run an initial scan on page load so the dashboard isn't empty
        await RunAutoAudit();
    }

    // --- CORE AUTOMATION LOGIC ---
    private async Task RunAutoAudit()
    {
        try 
        {
            isScanning = true;
            StateHasChanged(); // Force UI update to show spinner

            Console.WriteLine($"[Auditor] Starting automated compliance scan at {DateTime.Now}");
            
            // Simulate heavy database processing delay
            await Task.Delay(1200);

            // Clear previous scan
            AuditFlags.Clear();

            // RULE 1: Check for Expiring Licenses (Risk Management)
            // In real app: _context.Licenses.Where(l => l.Expiry < DateTime.Now.AddDays(30))
            AddFlag("Critical", "Licensing", "Adobe Creative Cloud license expired 2 days ago.", "Retail Corp");
            AddFlag("Warning", "Licensing", "Microsoft 365 E5 expiring in 14 days.", "Law Firm Z");

            // RULE 2: Check for Tasks marked 'Done' without Proof (Process Integrity)
            // In real app: _context.Tasks.Where(t => t.Status == 'Verified' && string.IsNullOrEmpty(t.Proof))
            AddFlag("Warning", "Process", "Task 'Server Migration' marked verified without attachment.", "Infrastructure Team");

            // RULE 3: Check for Security Anomalies (Access Control)
            // In real app: _context.AuditLogs.Where(l => l.Action == 'FailedLogin' && l.Count > 5)
            AddFlag("Low", "Security", "3 Failed login attempts detected from unknown IP.", "Admin Account");

            // CALCULATE SCORE
            // Why: Deduct points based on severity to give a quick health metric
            int deduction = (AuditFlags.Count(f => f.Severity == "Critical") * 15) 
                          + (AuditFlags.Count(f => f.Severity == "Warning") * 5)
                          + (AuditFlags.Count(f => f.Severity == "Low") * 2);
            
            ComplianceScore = Math.Max(0, 100 - deduction);

            Console.WriteLine($"[Auditor] Scan complete. Score: {ComplianceScore}%");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during automated audit scan.");
            AddFlag("Critical", "System", "Audit Engine Failure. Check logs.", "System Internal");
        }
        finally 
        {
            isScanning = false;
        }
    }

    // --- HELPER FUNCTIONS ---
    private void AddFlag(string severity, string category, string msg, string entity)
    {
        AuditFlags.Add(new AuditFlag 
        { 
            Severity = severity, 
            Category = category, 
            Message = msg, 
            EntityName = entity 
        });
    }

    // Logic to "Resolve" (Simulate action taken)
    private void ResolveFlag(AuditFlag flag)
    {
        // Why: Simulate taking action and clearing the risk
        Console.WriteLine($"[Auditor] Resolving flag: {flag.Id}");
        AuditFlags.Remove(flag);
        RecalculateScore();
    }

    private void PingTeamLead(AuditFlag flag)
    {
        Console.WriteLine($"[Auditor] Sending reminder to team lead for: {flag.EntityName}");
        // In real app: NotificationService.Send(flag.EntityName, "Please upload proof.");
        // We don't remove the flag immediately because they haven't fixed it yet!
    }

    private void NotifyAdmin(AuditFlag flag)
    {
        Console.WriteLine($"[Auditor] ESCALATING to Admin: {flag.Message}");
        // In real app: EmailService.SendAdminAlert(flag);
        ResolveFlag(flag); // Assume escalation counts as "handling" the dashboard alert
    }

    private void RecalculateScore()
    {
        int deduction = (AuditFlags.Count(f => f.Severity == "Critical") * 15) 
                      + (AuditFlags.Count(f => f.Severity == "Warning") * 5)
                      + (AuditFlags.Count(f => f.Severity == "Low") * 2);
        ComplianceScore = Math.Max(0, 100 - deduction);
    }

    private string GetScoreClass(int score)
    {
        if (score >= 90) return "score-high";
        if (score >= 70) return "score-med";
        return "score-low";
    }
}