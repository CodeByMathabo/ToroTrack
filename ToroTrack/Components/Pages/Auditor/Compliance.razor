@page "/auditor/compliance"
@using Microsoft.AspNetCore.Authorization
@using ToroTrack.Business.Services
@using ToroTrack.Models
@rendermode InteractiveServer
@inject ILogger<Compliance> Logger
@inject IComplianceService ComplianceService
@inject NavigationManager Navigation
@inject INotificationService NotificationService

<PageTitle>Compliance Intelligence | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Compliance Intelligence</h1>
            <p class="page-subtitle">Automated system health checks and risk detection.</p>
        </div>
        <div class="header-right">
            <button class="btn-primary-toro" @onclick="RunAutoAudit" disabled="@isScanning">
                @if (isScanning)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span> <span>Scanning Ecosystem...</span>
                }
                else
                {
                    <span class="bi bi-arrow-repeat me-2"></span> <span>Run Auto-Audit</span>
                }
            </button>
        </div>
    </header>

    @* METRICS ROW *@
    <div class="stats-container">
        @* Compliance Score Card *@
        <div class="stat-card @GetScoreClass(ComplianceScore)">
            <span class="stat-title">System Compliance Score</span>
            <div class="d-flex align-items-baseline gap-2">
                <span class="stat-number">@ComplianceScore%</span>
                <span class="stat-trend">
                    @if (ComplianceScore < 90) { <span class="bi bi-arrow-down-right"></span> }
                    else { <span class="bi bi-arrow-up-right"></span> }
                </span>
            </div>
            <small class="text-muted mt-2">Calculated via Live Real-time Rules</small>
        </div>

        @* Critical Risks Card *@
        <div class="stat-card">
            <span class="stat-title text-danger">Critical Risks</span>
            <span class="stat-number text-danger">@AuditFlags.Count(x => x.Severity == "Critical")</span>
            <small class="text-muted mt-2">Requires immediate attention</small>
        </div>

        @* Process Gaps Card *@
        <div class="stat-card">
            <span class="stat-title">Process Gaps</span>
            <span class="stat-number">@AuditFlags.Count(x => x.Category == "Process")</span>
            <small class="text-muted mt-2">Tasks missing proof of work</small>
        </div>
    </div>

    @* AUDIT REPORT TABLE *@
    <div class="audit-section mt-4">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="section-title">Live Risk Detected</h3>
            <div class="filter-badges">
                <span class="badge bg-light text-dark border">All (@AuditFlags.Count)</span>
                <span class="badge bg-danger-subtle text-danger border-danger">Critical (@AuditFlags.Count(x => x.Severity == "Critical"))</span>
            </div>
        </div>

        <div class="table-container">
            <table class="toro-table">
                <thead>
                    <tr>
                        <th style="width: 10%">Severity</th>
                        <th style="width: 15%">Category</th>
                        <th style="width: 40%">Issue Detected</th>
                        <th style="width: 20%">Entity Affected</th>
                        <th style="width: 15%" class="text-center">Auto-Action</th>
                    </tr>
                </thead>
                <tbody>
                    @if (AuditFlags.Any())
                    {
                        @foreach (var flag in AuditFlags.OrderByDescending(f => f.Severity))
                        {
                            <tr class="animate-fade-in">
                                <td>
                                    <span class="severity-pill @flag.Severity.ToLower()">@flag.Severity</span>
                                </td>
                                <td class="fw-bold text-muted">@flag.Category</td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        @if (flag.Category == "Licensing") { <span class="bi bi-credit-card-2-front text-warning"></span> }
                                        else if (flag.Category == "Security") { <span class="bi bi-shield-exclamation text-danger"></span> }
                                        else { <span class="bi bi-list-check text-primary"></span> }
                                        @flag.Message
                                    </div>
                                </td>
                                <td>@flag.EntityName</td>
                                <td class="text-center">
                                    @* Use the specific action logic based on category *@
                                    @if (flag.Category == "Licensing")
                                    {
                                        <button class="btn-action-sm btn-action-license" @onclick="() => NavigateToFix(flag)">
                                            <span class="bi bi-pencil-square"></span> Renew
                                        </button>
                                    }
                                    else if (flag.Category == "Process")
                                    {
                                        <button class="btn-action-sm btn-action-process" @onclick="() => PingTeamLead(flag)">
                                            <span class="bi bi-bell-fill"></span> Ping Team
                                        </button>
                                    }
                                    else if (flag.Category == "Security")
                                    {
                                        <button class="btn-action-sm btn-action-security" @onclick="() => NotifyAdmin(flag)">
                                            <span class="bi bi-shield-lock-fill"></span> Alert Admin
                                        </button>
                                    }
                                    else
                                    {
                                        <button class="btn-action-sm" @onclick="() => ResolveFlag(flag)">
                                            <span class="bi bi-check2"></span> Resolve
                                        </button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="5" class="text-center py-5 text-muted">
                                <span class="bi bi-shield-check display-1 d-block mb-3 text-success" style="opacity: 0.5"></span>
                                System is fully compliant. No risks detected.
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@code {
    // --- STATE MANAGEMENT ---
    private bool isScanning = false;
    private int ComplianceScore = 100;
    private List<AuditFlag> AuditFlags = new();

    // --- INITIALIZATION ---
    protected override async Task OnInitializedAsync()
    {
        await RunAutoAudit();
    }

    // --- CORE AUTOMATION LOGIC ---
    private async Task RunAutoAudit()
    {
        try 
        {
            isScanning = true;
            // Why: Yield control to UI to allow spinner to render
            await Task.Yield(); 

            // Why: Delegate complex logic to the service layer for maintainability
            var result = await ComplianceService.RunComplianceScanAsync();
            
            ComplianceScore = result.Score;
            AuditFlags = result.Flags;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during automated audit scan.");
            AuditFlags.Add(new AuditFlag { Severity = "Critical", Message = "UI Failure during scan." });
        }
        finally 
        {
            isScanning = false;
            StateHasChanged();
        }
    }

    // --- ACTION HANDLERS ---
    private void NavigateToFix(AuditFlag flag)
    {
        if(!string.IsNullOrEmpty(flag.ActionUrl))
        {
            Navigation.NavigateTo(flag.ActionUrl);
        }
    }

    private void ResolveFlag(AuditFlag flag)
    {
        // Why: In a real scenario, this would call an API to mark the issue as ignored or resolved
        AuditFlags.Remove(flag);
        RecalculateScore();
    }

    private async Task PingTeamLead(AuditFlag flag)
    {
        try 
        {
            isScanning = true; // Show loading state
            
            // 1. Call the backend to perform the database update
            await ComplianceService.ResolveRiskAsync(flag, "Ping");

            // 2. Visual Feedback
            Logger.LogInformation($"Action taken on {flag.EntityName}");
            
            // 3. Remove from UI immediately (Optimistic update)
            AuditFlags.Remove(flag);
            RecalculateScore();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to resolve risk.");
        }
        finally
        {
            isScanning = false;
        }
    }

    private void NotifyAdmin(AuditFlag flag)
    {
        Logger.LogWarning($"Escalated to Admin: {flag.Message}");
        ResolveFlag(flag); 
    }

    private void RecalculateScore()
    {
        int deduction = (AuditFlags.Count(f => f.Severity == "Critical") * 15) 
                      + (AuditFlags.Count(f => f.Severity == "Warning") * 5)
                      + (AuditFlags.Count(f => f.Severity == "Low") * 2);
        ComplianceScore = Math.Max(0, 100 - deduction);
    }

    private string GetScoreClass(int score)
    {
        if (score >= 90) return "score-high";
        if (score >= 70) return "score-med";
        return "score-low";
    }
}