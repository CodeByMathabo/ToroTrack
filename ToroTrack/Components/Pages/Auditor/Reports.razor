@page "/auditor/reports"
@using Microsoft.AspNetCore.Authorization
@using ToroTrack.Components.Layout
@using ToroTrack.Business.Services
@using ToroTrack.Data.Entities
@inject ReportService ReportService
@inject AuthenticationStateProvider AuthStateProvider
@attribute [Authorize(Roles = "Auditor, Admin")] 
@rendermode InteractiveServer

<PageTitle>Reports | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Audit Reports</h1>
            <p class="page-subtitle">Generate and export system compliance snapshots.</p>
        </div>
    </header>

    @* GENERATOR CARD *@
    <div class="generator-card mb-5">
        <h3 class="card-title"><span class="bi bi-sliders me-2"></span> Report Configuration</h3>
        
        <div class="config-grid">
            @* Report Type Selection *@
            <div class="form-group">
                <label class="toro-label">Report Type</label>
                <select class="toro-input" @bind="SelectedReportType">
                    <option value="ComplianceSummary">Compliance Risk Summary</option>
                    <option value="AssetInventory">Full Asset Inventory</option>
                    <option value="SecurityAudit">Security Audit Log</option>
                    <option value="LicensingCosts">Licensing & Cost Projection</option>
                </select>
            </div>

            @* Date Range Logic *@
            <div class="form-group">
                <label class="toro-label">Reporting Period</label>
                
                <select class="toro-input mb-2" @onchange="OnDateRangeChanged">
                    <option value="30">Last 30 Days</option>
                    <option value="90">Last 3 Months</option>
                    <option value="180">Last 6 Months</option>
                    <option value="custom">Custom Range...</option>
                </select>

                @if (IsCustomRange)
                {
                    <div class="d-flex gap-2 animate-fade-in">
                        <div class="w-50">
                            <label class="small-label text-muted" style="font-size: 0.7rem;">From</label>
                            <input type="date" class="toro-input" @bind="StartDate" max="@EndDate.ToString("yyyy-MM-dd")" />
                        </div>
                        <div class="w-50">
                            <label class="small-label text-muted" style="font-size: 0.7rem;">To</label>
                            <input type="date" class="toro-input" @bind="EndDate" min="@StartDate.ToString("yyyy-MM-dd")" />
                        </div>
                    </div>
                }
                else
                {
                    <div class="text-muted small ms-1 animate-fade-in">
                        <span class="bi bi-calendar3 me-2"></span>
                        <strong>@StartDate.ToString("MMM dd")</strong> to <strong>@EndDate.ToString("MMM dd, yyyy")</strong>
                    </div>
                }
            </div>

            @* Format Selection *@
            <div class="form-group">
                <label class="toro-label">Export Format</label>
                <div class="format-toggles">
                    <button class="btn-format @(SelectedFormat == "PDF" ? "active" : "")" @onclick='() => SelectedFormat = "PDF"'>
                        <span class="bi bi-file-earmark-pdf-fill text-danger"></span> PDF
                    </button>
                    <button class="btn-format @(SelectedFormat == "CSV" ? "active" : "")" @onclick='() => SelectedFormat = "CSV"'>
                        <span class="bi bi-file-earmark-excel-fill text-success"></span> CSV
                    </button>
                </div>
            </div>
        </div>

        <div class="card-footer-actions">
            <button class="btn-primary-toro" @onclick="GenerateReport" disabled="@IsGenerating">
                @if (IsGenerating)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span> <span>Processing...</span>
                }
                else
                {
                    <span class="bi bi-download me-2"></span> <span>Generate & Download</span>
                }
            </button>
        </div>
    </div>

    @* RECENT REPORTS HISTORY *@
    <h3 class="section-title mb-3">Recent Reports</h3>
    <div class="table-container">
        <table class="toro-table">
            <thead>
                <tr>
                    <th style="width: 30%">Report Name</th>
                    <th style="width: 15%">Type</th>
                    <th style="width: 15%">Date Generated</th>
                    <th style="width: 20%">Generated By</th>
                    <th style="width: 20%" class="text-center">Action</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var report in RecentReports)
                {
                    <tr class="animate-fade-in">
                        <td>
                            <div class="d-flex align-items-center gap-2">
                                @if (report.Format == "PDF")
                                {
                                    <span class="bi bi-file-earmark-pdf-fill text-danger fs-5"></span>
                                }
                                else
                                {
                                    <span class="bi bi-file-earmark-excel-fill text-success fs-5"></span>
                                }
                                <span class="fw-bold">@report.Name</span>
                            </div>
                        </td>
                        <td>
                            <span class="badge-type">@report.Type</span>
                        </td>
                        <td class="text-monospace text-muted">@report.DateGenerated.ToString("MMM dd, yyyy")</td>
                        <td>
                            <div class="user-cell">
                                <div class="avatar-xs bg-secondary">@(report.GeneratedBy.Length > 0 ? report.GeneratedBy.Substring(0,1) : "?")</div>
                                <span class="small-role text-dark">@report.GeneratedBy</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <button class="btn-download-solid" @onclick="() => DownloadReport(report)">
                                <span class="bi bi-cloud-arrow-down-fill me-2"></span> Download
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    // State
    private string SelectedReportType = "ComplianceSummary";
    private DateTime StartDate = DateTime.Now.AddDays(-30);
    private DateTime EndDate = DateTime.Now;
    private bool IsCustomRange = false;
    private string SelectedFormat = "PDF";
    private bool IsGenerating = false;
    private string CurrentUser = "System";

    // Data List
    private List<ReportLog> RecentReports = new();

    protected override async Task OnInitializedAsync()
    {
        try 
        {
            // Why: Fetch the current logged-in user to attribute the report generation correctly
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                CurrentUser = user.Identity.Name ?? "Auditor";
            }

            // Why: Load historical data from the database instead of using mock data
            RecentReports = await ReportService.GetReportHistoryAsync();
        }
        catch(Exception ex)
        {
            Console.WriteLine($"[Reports Page] Init Error: {ex.Message}");
        }
    }

    private void OnDateRangeChanged(ChangeEventArgs e)
    {
        var val = e.Value?.ToString();
        if (val == "custom")
        {
            IsCustomRange = true;
        }
        else if (int.TryParse(val, out int days))
        {
            IsCustomRange = false;
            EndDate = DateTime.Now;
            StartDate = DateTime.Now.AddDays(-days);
        }
    }

    private async Task GenerateReport()
    {
        IsGenerating = true;
        try 
        {
            // Why: Delegate complex generation logic to the service layer for maintainability
            var newReport = await ReportService.GenerateReportAsync(
                SelectedReportType, 
                SelectedFormat, 
                StartDate, 
                EndDate, 
                CurrentUser
            );

            // Update UI list
            RecentReports.Insert(0, newReport);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[Reports Page] Generation Error: {ex.Message}");
        }
        finally
        {
            IsGenerating = false;
        }
    }

    private async Task DownloadReport(ReportLog report)
    {
        await ReportService.DownloadReportAsync(report);
    }
}