@page "/auditor/license"
@using Microsoft.AspNetCore.Authorization
@using ToroTrack.Components.Layout
@using ToroTrack.Business.Services
@using ToroTrack.Data
@* Explicit alias to avoid conflict with the component class name *@
@using LicenseEntity = ToroTrack.Data.Entities.License

@attribute [Authorize(Roles = "Auditor")]
@inject LicenseService LicenseService
@inject ILogger<License> Logger
@rendermode InteractiveServer

<PageTitle>License Registry | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">License Registry</h1>
            <p class="page-subtitle">Manage software entitlements and hardware allocations.</p>
        </div>
        <div class="header-right">
            <div class="search-wrapper">
                <span class="bi bi-search search-icon"></span>
                <input type="text" class="toro-search" placeholder="Search..." @bind="SearchQuery" @bind:event="oninput" />
            </div>

            @* Clearly labeled as Manual Override *@
            <button class="btn-manual-override" @onclick="OpenAddModal" title="Emergency/Legacy Entry Only">
                <span class="bi bi-keyboard me-2"></span> Manual Entry
            </button>
        </div>
    </header>

    @* LIST VIEW TABLE *@
    <div class="table-container">
        <table class="toro-table">
            <thead>
                <tr>
                    <th style="width: 25%">Software / Asset</th>
                    <th style="width: 15%">Client</th>
                    <th style="width: 15%">Source</th>
                    <th style="width: 15%">Expiry Date</th>
                    <th style="width: 15%">Cost</th>
                    <th style="width: 15%" class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (IsLoading)
                {
                    <tr><td colspan="6" class="text-center py-4">Loading data...</td></tr>
                }
                else if (!FilteredLicenses.Any())
                {
                    <tr><td colspan="6" class="text-center py-4">No records found.</td></tr>
                }
                else
                {
                    @foreach (var license in FilteredLicenses)
                    {
                        <tr>
                            <td class="fw-bold">
                                <span class="@GetIconClass(license.Type) me-2 text-muted"></span>
                                @license.SoftwareName
                            </td>
                            <td>@(license.Client?.FullName ?? "Unknown")</td>

                            @* Source Badge Logic *@
                            <td>
                                @if (license.Source == "System Order")
                                {
                                    <span class="badge-source auto">
                                        <span class="bi bi-lightning-charge-fill me-1"></span> System Order
                                    </span>
                                }
                                else
                                {
                                    <span class="badge-source manual">
                                        <span class="bi bi-person-fill-gear me-1"></span> Manual Entry
                                    </span>
                                }
                            </td>

                            <td>
                                @* Expiry Warning Logic *@
                                @if (GetDaysRemaining(license.ExpiryDate) < 30)
                                {
                                    <span class="text-danger fw-bold">@license.ExpiryDate.ToString("MMM dd")</span>
                                    <span class="bi bi-exclamation-circle-fill text-danger ms-1" title="Expiring"></span>
                                }
                                else
                                {
                                    <span>@license.ExpiryDate.ToString("MMM dd, yyyy")</span>
                                }
                            </td>
                            <td>R @license.Cost.ToString("N2")</td>
                            <td class="text-center">
                                <button class="btn-edit-table" @onclick="() => EditLicense(license)">
                                    <span class="bi bi-pencil-square me-1"></span> Edit / Override
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
    </div>
</div>

@* ADD/EDIT MODAL *@
<ToroModal @bind-IsVisible="isModalVisible" Title="@modalTitle">

    @if (CurrentLicense.Source == "System Order")
    {
        <div class="alert alert-info mb-3 small">
            <span class="bi bi-info-circle-fill me-2"></span>
            <strong>Automated Record:</strong> This license was created by a client order. Only edit if you need to correct a system error.
        </div>
    }
    else
    {
        <div class="alert alert-warning mb-3 small">
            <span class="bi bi-exclamation-triangle-fill me-2"></span>
            <strong>Manual Entry:</strong> Ensure you have a signed paper trail before creating records manually.
        </div>
    }

    <div class="form-group mb-3">
        <label class="small-label">License Name</label>
        <input @bind="CurrentLicense.SoftwareName" class="form-control" placeholder="e.g. Microsoft 365 E5" />
    </div>

    @* Replaced Text Input with Dropdown for Data Integrity *@
    <div class="form-group mb-3">
        <label class="small-label">Client</label>
        <select @bind="CurrentLicense.ClientId" class="form-control">
            <option value="">-- Select Client --</option>
            @foreach (var client in Clients)
            {
                <option value="@client.Id">@client.FullName (@client.Email)</option>
            }
        </select>
    </div>

    <div class="row">
        <div class="col-6">
            <div class="form-group mb-3">
                <label class="small-label">Expiry Date</label>
                <input type="date" @bind="CurrentLicense.ExpiryDate" class="form-control" />
            </div>
        </div>
        <div class="col-6">
            <div class="form-group mb-3">
                <label class="small-label">Cost (ZAR)</label>
                <input type="number" @bind="CurrentLicense.Cost" class="form-control" />
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-6">
            <div class="form-group mb-3">
                <label class="small-label">Type</label>
                <select @bind="CurrentLicense.Type" class="form-control">
                    <option value="Software">Software</option>
                    <option value="Hardware">Hardware</option>
                </select>
            </div>
        </div>
        <div class="col-6">
            <div class="form-group mb-3">
                <label class="small-label">Record Source</label>
                @* Source is Read-Only *@
                <input value="@CurrentLicense.Source" class="form-control bg-light" disabled />
            </div>
        </div>
    </div>

    <div class="text-end mt-3">
        <button class="btn-primary-toro" @onclick="SaveLicense">Save Record</button>
    </div>
</ToroModal>

@code {
    private string SearchQuery = "";
    private bool isModalVisible = false;
    private bool IsLoading = true;
    private string modalTitle = "Add License";

    // Why: Use the actual Entity instead of a local class
    private LicenseEntity CurrentLicense = new();
    private List<LicenseEntity> Licenses = new();
    private List<ApplicationUser> Clients = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Why: Load data concurrently for better performance
            var licenseTask = LicenseService.GetAllLicensesAsync();
            var clientTask = LicenseService.GetClientsAsync();

            await Task.WhenAll(licenseTask, clientTask);

            Licenses = await licenseTask;
            Clients = await clientTask;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error initializing License page");
        }
        finally
        {
            IsLoading = false;
        }
    }

    private IEnumerable<LicenseEntity> FilteredLicenses =>
        string.IsNullOrWhiteSpace(SearchQuery)
        ? Licenses
        : Licenses.Where(l => l.SoftwareName.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase)
                             || (l.Client?.FullName?.Contains(SearchQuery, StringComparison.OrdinalIgnoreCase) ?? false));

    private void OpenAddModal()
    {
        // Why: Initialize defaults for manual entry
        CurrentLicense = new LicenseEntity
        {
            ExpiryDate = DateTime.Now.AddYears(1),
            Source = "Manual Entry",
            Status = "Active"
        };
        modalTitle = "Manual License Entry";
        isModalVisible = true;
    }

    private void EditLicense(LicenseEntity item)
    {
        // Why: Clone logic could be added here if we wanted to avoid direct reference editing before save
        CurrentLicense = item;
        modalTitle = "Edit / Override License";
        isModalVisible = true;
    }

    private async Task SaveLicense()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(CurrentLicense.SoftwareName) || string.IsNullOrWhiteSpace(CurrentLicense.ClientId))
            {
                // Basic validation; could use EditForm/DataAnnotationsValidator
                return;
            }

            await LicenseService.SaveLicenseAsync(CurrentLicense);

            // Refresh list
            Licenses = await LicenseService.GetAllLicensesAsync();
            isModalVisible = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving license");
        }
    }

    private int GetDaysRemaining(DateTime date) => (date - DateTime.Now).Days;
    private string GetIconClass(string type) => type == "Hardware" ? "bi bi-laptop" : "bi bi-microsoft";
}