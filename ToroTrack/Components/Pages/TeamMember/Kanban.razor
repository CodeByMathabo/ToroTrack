@page "/team/kanban"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using ToroTrack.Components.Layout
@using ToroTrack.Data
@using ToroTrack.Data.Entities
@using ToroTrack.Models

@rendermode InteractiveServer

@* Enforce Security: Only Team Members and Admins can enter *@
@attribute [Authorize(Roles = "Admin, TeamMember")]

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ILogger<Kanban> Logger
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager

<PageTitle>Kanban Board | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Task Board</h1>
            <p class="page-subtitle">Manage project tasks and workflow.</p>
        </div>

        <div class="header-center">
            <div class="search-wrapper">
                <select class="project-select" @onchange="OnProjectSelected" value="@(SelectedProjectId?.ToString() ?? "")">
                    <option value="">
                        @if (VisibleProjects.Any())
                        {
                            <text>-- Select Active Project --</text>
                        }
                        else
                        {
                            <text>-- No Active Projects --</text>
                        }
                    </option>
                    @foreach (var proj in VisibleProjects)
                    {
                        <option value="@proj.Id">@proj.Client?.FirstName @proj.Client?.LastName - @proj.Name</option>
                    }
                </select>
            </div>
        </div>

        <div class="header-right d-flex gap-2 align-items-center">
            <div class="stage-indicator">
                <span class="stage-label">My Job:</span>
                <span class="stage-value">@CurrentUserJobRole</span>
            </div>

            <button class="btn-primary-action" @onclick="OpenCreateModal">
                <span class="bi bi-plus-lg"></span> New Task
            </button>
        </div>
    </header>

    @* FILTER BAR REMOVED - 'My Job' indicator handles context *@

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @ErrorMessage
            <button type="button" class="btn-close" @onclick='() => ErrorMessage = ""'></button>
        </div>
    }

    <div class="kanban-board">
        @* COLUMN 1: BACKLOG *@
        <div class="kanban-column">
            <div class="column-header">
                <span>Backlog</span>
                <span class="count-badge">@FilteredTasks.Count(t => t.Status == "Backlog")</span>
            </div>
            <div class="column-body">
                @foreach (var task in FilteredTasks.Where(t => t.Status == "Backlog"))
                {
                    <div class="kanban-card">
                        @RenderCardContent(task)

                        @* Smart Action Button *@
                        @if (!string.IsNullOrEmpty(GetActionLink(task.Title)))
                        {
                            <a href="@GetActionLink(task.Title)" class="btn btn-sm btn-outline-dark w-100 mb-2 mt-2" style="font-size: 0.75rem; border-style: dashed;">
                                <span class="bi bi-box-arrow-up-right"></span> Go to Task Page
                            </a>
                        }

                        <div class="card-actions">
                            @if (CanInteractWithTask(task))
                            {
                                <button class="btn-move" @onclick='() => MoveTask(task, "Doing")'>
                                    Start <span class="bi bi-arrow-right-short"></span>
                                </button>
                            }
                            else
                            {
                                <span class="text-muted small fst-italic"><i class="bi bi-lock-fill"></i> View Only</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        @* COLUMN 2: DOING *@
        <div class="kanban-column">
            <div class="column-header">
                <span>In Progress</span>
                <span class="count-badge">@FilteredTasks.Count(t => t.Status == "Doing")</span>
            </div>
            <div class="column-body">
                @foreach (var task in FilteredTasks.Where(t => t.Status == "Doing"))
                {
                    <div class="kanban-card doing-card">
                        @RenderCardContent(task)

                        @* Smart Action Button *@
                        @if (!string.IsNullOrEmpty(GetActionLink(task.Title)))
                        {
                            <a href="@GetActionLink(task.Title)" class="btn btn-sm btn-outline-dark w-100 mb-2 mt-2" style="font-size: 0.75rem; border-style: dashed;">
                                <span class="bi bi-box-arrow-up-right"></span> Go to Task Page
                            </a>
                        }

                        <div class="card-actions">
                            @if (CanInteractWithTask(task))
                            {
                                <button class="btn-move-back" @onclick='() => MoveTask(task, "Backlog")'>
                                    <span class="bi bi-arrow-left-short"></span>
                                </button>
                                <button class="btn-move" @onclick='() => InitiateCompleteTask(task)'>
                                    Done <span class="bi bi-arrow-right-short"></span>
                                </button>
                            }
                            else
                            {
                                <span class="text-muted small fst-italic"><i class="bi bi-lock-fill"></i> View Only</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        @* COLUMN 3: DONE *@
        <div class="kanban-column">
            <div class="column-header">
                <span>Done / Review</span>
                <span class="count-badge">@FilteredTasks.Count(t => t.Status == "PendingReview" || t.Status == "Verified")</span>
            </div>
            <div class="column-body">
                @foreach (var task in FilteredTasks.Where(t => t.Status == "PendingReview" || t.Status == "Verified"))
                {
                    <div class="kanban-card done-card">
                        <div class="card-content">
                            <p class="task-title text-decoration-line-through text-muted">
                                @if (task.Status == "Verified")
                                {
                                    <span class="bi bi-check-circle-fill text-success me-2"></span>
                                }
                                else
                                {
                                    <span class="bi bi-hourglass-split text-warning me-2"></span>
                                }
                                @task.Title
                            </p>

                            <div class="d-flex justify-content-between align-items-center mt-2">
                                @if (task.Status == "PendingReview")
                                {
                                    <span class="badge bg-warning text-dark">Pending Review</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Verified</span>
                                }
                                <span class="team-tag-mini">@GetTeamShortCode(task.AssignedToId)</span>
                            </div>

                            @if (!string.IsNullOrEmpty(task.ProofUrl))
                            {
                                <div class="mt-1 small text-muted"><span class="bi bi-paperclip"></span> Attached</div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@* --- MODALS --- *@

@* 1. NEW TASK MODAL *@
<ToroModal @bind-IsVisible="isCreateModalVisible" Title="Create New Task">
    <div class="modern-modal-form">
        <p class="text-muted mb-3 small">Adding task to <strong>@GetProjectName(SelectedProjectId)</strong></p>

        <div class="alert alert-info py-2 px-3 small mb-3">
            <i class="bi bi-clock-history me-1"></i>
            <strong>Policy:</strong> The 5-day timer starts <strong>NOW</strong>. Only create this task if you are ready to begin.
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Select Stage</label>
            <select class="form-select task-input-modern" @onchange="OnStageSelected">
                <option value="">-- Select a Stage to Start --</option>
                @foreach (var stage in StageOptions)
                {
                    <option value="@stage.Title">@stage.Title</option>
                }
                <option value="Custom">Custom / Ad-hoc Task</option>
            </select>
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Task Title</label>
            <input @bind="NewTaskModel.Title" class="form-control task-input-modern"
                   placeholder="Task Title will appear here..."
                   readonly="@(!IsCustomTask)" />
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Description</label>
            <textarea @bind="NewTaskModel.Description" class="form-control task-input-modern" rows="3"
                      placeholder="Task details..."
                      readonly="@(!IsCustomTask)"></textarea>
        </div>

        <div class="row">
            <div class="col-6 form-group mb-3">
                <label class="small-label">Start Date</label>
                <input type="text" class="form-control task-input-modern bg-light" value="@DateTime.Now.ToShortDateString()" readonly />
                <small class="text-muted" style="font-size:0.7rem">Starts Today</small>
            </div>
            <div class="col-6 form-group mb-3">
                <label class="small-label">Role / Team</label>
                <input type="text" class="form-control task-input-modern bg-light" value="@NewTaskModel.AssignedToId" disabled />
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 border-top pt-3">
            <button class="btn-cancel-task" @onclick="() => isCreateModalVisible = false">Cancel</button>
            <button class="btn-save-task" @onclick="CreateTaskAsync">Start Task</button>
        </div>
    </div>
</ToroModal>

@* 2. PROOF MODAL *@
<ToroModal @bind-IsVisible="isProofModalVisible" Title="Submit Proof">
    <div class="new-task-form border-0 shadow-none p-0">
        <p class="text-muted mb-3 small">Upload screenshots, logs, or provide a link for <strong>@TaskToComplete?.Title</strong>.</p>

        <div class="form-group mb-2">
            <label class="small-label">Proof Link / URL</label>
            <input @bind="ProofUrlInput" class="form-control task-input-compact" placeholder="https://..." />
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Or Upload File</label>
            <InputFile OnChange="HandleFileSelected" class="form-control task-input-compact" />
            @if (!string.IsNullOrEmpty(ProofModel.FileName))
            {
                <div class="text-success small mt-1"><span class="bi bi-check2"></span> @ProofModel.FileName attached</div>
            }
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn-cancel-task" @onclick="() => isProofModalVisible = false">Cancel</button>
            <button class="btn-save-task" @onclick="SubmitProofAsync">Submit & Complete</button>
        </div>
    </div>
</ToroModal>

@code {
    // --- State & Auth ---
    private List<Project> Projects = new();
    private List<ProjectTask> Tasks = new();
    private List<Project> VisibleProjects = new();

    private string CurrentTeamFilter = "All";
    private int? SelectedProjectId = null;
    private string ErrorMessage = "";

    private string CurrentUserJobRole = "Loading...";
    private string CurrentUserIdentityRole = "";
    private bool IsAdmin = false;

    // --- Models & UI Logic ---
    private bool isCreateModalVisible = false;
    private bool isProofModalVisible = false;

    private ProjectTask NewTaskModel = new();
    private ProjectTask? TaskToComplete;
    private string ProofUrlInput = "";

    private List<(string Title, string Description)> StageOptions = new();
    private bool IsCustomTask = false;

    private class ProofOfWork { public string FileName { get; set; } = ""; }
    private ProofOfWork ProofModel = new();

    private IEnumerable<ProjectTask> FilteredTasks => Tasks
        .Where(t => SelectedProjectId == null || t.ProjectId == SelectedProjectId)
        .Where(t => CurrentTeamFilter == "All" || t.AssignedToId == CurrentTeamFilter);

    protected override async Task OnInitializedAsync()
    {
        await LoadUserRoleAsync();
        await LoadDataAsync();
    }

    private async Task LoadUserRoleAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        if (principal.Identity?.IsAuthenticated == true)
        {
            if (principal.IsInRole("Admin"))
            {
                IsAdmin = true;
                CurrentUserIdentityRole = "Admin";
                CurrentUserJobRole = "Admin";
            }
            else if (principal.IsInRole("TeamMember"))
            {
                CurrentUserIdentityRole = "TeamMember";
                try
                {
                    var user = await UserManager.GetUserAsync(principal);
                    CurrentUserJobRole = user?.JobRole ?? "Unassigned";
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Failed to load user details");
                    CurrentUserJobRole = "Error";
                }
            }
        }
    }

    private bool CanInteractWithTask(ProjectTask task)
    {
        if (IsAdmin) return true;
        return task.AssignedToId == CurrentUserJobRole;
    }

    private async Task LoadDataAsync()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();

            Projects = await context.Projects
                .Include(p => p.Client)
                .Include(p => p.Tasks)
                .Where(p => p.Status == "Active")
                .ToListAsync();

            Tasks = Projects.SelectMany(p => p.Tasks).ToList();
            VisibleProjects = Projects;

            if (!IsAdmin && CurrentUserJobRole != "Unassigned" && CurrentUserJobRole != "Loading...")
            {
                CurrentTeamFilter = CurrentUserJobRole;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading data: {ex.Message}";
            Logger.LogError(ex, "Failed to load Kanban data");
        }
    }

    private void OnProjectSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id)) SelectedProjectId = id;
        else SelectedProjectId = null;
    }

    private string GetProjectName(int? id) => Projects.FirstOrDefault(p => p.Id == id)?.Name ?? "Unknown";

    // --- NEW TASK LOGIC ---
    private void OpenCreateModal()
    {
        if (SelectedProjectId == null)
        {
            ErrorMessage = "Please select a Project from the dropdown first.";
            return;
        }

        ErrorMessage = "";
        NewTaskModel = new ProjectTask
        {
            ProjectId = SelectedProjectId.Value,
            Status = "Backlog",
            // Always assign to user's role (or Admin default)
            AssignedToId = IsAdmin ? "Platform Engineer" : CurrentUserJobRole
        };

        LoadStagesForRole(NewTaskModel.AssignedToId);
        IsCustomTask = false;

        isCreateModalVisible = true;
    }

    private void OnStageSelected(ChangeEventArgs e)
    {
        var selectedTitle = e.Value?.ToString();

        if (selectedTitle == "Custom")
        {
            IsCustomTask = true;
            NewTaskModel.Title = "";
            NewTaskModel.Description = "";
        }
        else
        {
            IsCustomTask = false;
            var stage = StageOptions.FirstOrDefault(s => s.Title == selectedTitle);
            if (stage != default)
            {
                NewTaskModel.Title = stage.Title;
                NewTaskModel.Description = stage.Description;
            }
        }
    }

    private void LoadStagesForRole(string role)
    {
        StageOptions = role switch
        {
            "Logistics Coordinator" => new()
            {
                ("Stage 1: Catalog Verification", "Review the 'Catalog' page. Ensure stock levels are accurate."),
                ("Stage 2: Order Monitoring", "Monitor incoming requests on the 'Verify Tasks' or Orders page."),
                ("Stage 3: Stock Allocation", "Physically set aside hardware in the warehouse."),
                ("Stage 4: Asset Registration", "Register serial numbers in the 'Assets' system."),
                ("Stage 5: Final Dispatch", "Coordinate courier pickup and mark project as deployed.")
            },
            "Platform Engineer" => new()
            {
                ("Stage 1: Infrastructure Audit", "Assess current on-premise server environment."),
                ("Stage 2: Virtualization Setup", "Configure Hyper-V/VMware host environment."),
                ("Stage 3: Server Provisioning", "Deploy Windows Server instances."),
                ("Stage 4: Backup Configuration", "Setup local and offsite backup routines."),
                ("Stage 5: Disaster Recovery Test", "Simulate failure and verify recovery.")
            },
            "Network Security Engineer" => new()
            {
                ("Stage 1: Network Mapping", "Document existing IP schema and topology."),
                ("Stage 2: Firewall Configuration", "Configure VLANs and inbound/outbound rules."),
                ("Stage 3: VPN Tunneling", "Setup secure Site-to-Site or Client VPNs."),
                ("Stage 4: Penetration Testing", "Run vulnerability scan and patch critical risks."),
                ("Stage 5: Security Sign-off", "Generate security report and obtain client approval.")
            },
            "Cloud Engineer" => new()
            {
                ("Stage 1: Tenant Initialization", "Setup Azure/AWS tenant and billing alerts."),
                ("Stage 2: Identity Sync", "Configure Azure AD Connect for user synchronization."),
                ("Stage 3: Data Migration", "Execute lift-and-shift of file server data to cloud."),
                ("Stage 4: Cutover", "Switch DNS records and go live."),
                ("Stage 5: Post-Migration Support", "Monitor logs for 48 hours and resolve sync errors.")
            },
            "Modern Workplace Engineer" => new()
            {
                ("Stage 1: M365 Licensing", "Assign Business Premium licenses to users."),
                ("Stage 2: Email Migration", "Migrate Exchange mailboxes to Exchange Online."),
                ("Stage 3: Endpoint Manager", "Enroll devices in Intune/Autopilot."),
                ("Stage 4: Policy Deployment", "Push security policies (BitLocker, MFA)."),
                ("Stage 5: User Training", "Conduct Teams/OneDrive training session.")
            },
            _ => new()
        };
    }

    private async Task CreateTaskAsync()
    {
        if (string.IsNullOrWhiteSpace(NewTaskModel.Title)) return;

        try
        {
            using var context = DbFactory.CreateDbContext();
            NewTaskModel.StartDate = DateTime.UtcNow;
            NewTaskModel.DueDate = DateTime.UtcNow.AddDays(5);

            context.ProjectTasks.Add(NewTaskModel);
            await context.SaveChangesAsync();

            isCreateModalVisible = false;
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Database Error: {ex.Message}";
        }
    }

    private async Task MoveTask(ProjectTask task, string newStatus)
    {
        if (!CanInteractWithTask(task))
        {
            ErrorMessage = "You are not authorized to move this task.";
            return;
        }

        try
        {
            using var context = DbFactory.CreateDbContext();
            var dbTask = await context.ProjectTasks.FindAsync(task.Id);
            if (dbTask != null)
            {
                dbTask.Status = newStatus;
                await context.SaveChangesAsync();
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Failed to move task.";
        }
    }

    private void InitiateCompleteTask(ProjectTask task)
    {
        if (!CanInteractWithTask(task)) return;
        TaskToComplete = task;
        ProofUrlInput = "";
        isProofModalVisible = true;
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        ProofModel.FileName = e.File.Name;
    }

    private async Task SubmitProofAsync()
    {
        if (TaskToComplete == null) return;

        try
        {
            using var context = DbFactory.CreateDbContext();
            var dbTask = await context.ProjectTasks.FindAsync(TaskToComplete.Id);
            if (dbTask != null)
            {
                dbTask.Status = "PendingReview";
                dbTask.ProofUrl = string.IsNullOrWhiteSpace(ProofUrlInput) ? ProofModel.FileName : ProofUrlInput;
                await context.SaveChangesAsync();
                isProofModalVisible = false;
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Failed to submit proof.";
        }
    }

    private RenderFragment RenderCardContent(ProjectTask task) => __builder =>
    {
        <div class="card-content">
            <div class="d-flex justify-content-between align-items-start mb-1">
                <span class="badge-priority medium">Medium</span>
                @if (CurrentTeamFilter == "All")
                {
                    <span class="team-badge-xs">@GetTeamShortCode(task.AssignedToId)</span>
                }
            </div>
            <p class="task-title">@task.Title</p>
            <p class="task-desc">@task.Description</p>
        </div>
    };

    private string? GetActionLink(string title)
    {
        if (title.Contains("Catalog", StringComparison.OrdinalIgnoreCase)) return "/admin/catalog";
        if (title.Contains("Order", StringComparison.OrdinalIgnoreCase) || title.Contains("Verify", StringComparison.OrdinalIgnoreCase)) return "/admin/verify";
        if (title.Contains("Asset", StringComparison.OrdinalIgnoreCase) && !title.Contains("Tag", StringComparison.OrdinalIgnoreCase)) return "/admin/catalog";
        return null;
    }

    private string GetTeamShortCode(string? fullTeam) => fullTeam switch
    {
        "Logistics Coordinator" => "LOG",
        "Platform Engineer" => "PLATFORM",
        "Network Security Engineer" => "NETSEC",
        "Cloud Engineer" => "CLOUD",
        "Modern Workplace Engineer" => "M365",
        _ => "GEN"
    };
}