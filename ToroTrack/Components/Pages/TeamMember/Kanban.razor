@page "/team/kanban"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using ToroTrack.Components.Layout
@using ToroTrack.Data
@using ToroTrack.Data.Entities
@rendermode InteractiveServer

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ILogger<Kanban> Logger
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Kanban Board | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Task Board</h1>
            <p class="page-subtitle">Manage project tasks and workflow.</p>
        </div>

        <div class="header-center">
            <div class="search-wrapper">
                <select class="project-select" @onchange="OnProjectSelected" value="@(SelectedProjectId?.ToString() ?? "")">
                    <option value="">
                        @if (VisibleProjects.Any())
                        {
                            <text>-- Select Active Project --</text>
                        }
                        else
                        {
                            <text>-- No Active Projects --</text>
                        }
                    </option>
                    @foreach (var proj in VisibleProjects)
                    {
                        <option value="@proj.Id">@proj.Client?.FirstName @proj.Client?.LastName - @proj.Name</option>
                    }
                </select>
            </div>
        </div>

        <div class="header-right d-flex gap-2 align-items-center">
            <div class="stage-indicator">
                <span class="stage-label">My Role:</span>
                <span class="stage-value">@CurrentUserRole</span>
            </div>

            @* Only show 'New Task' if user is allowed to create tasks (Optional: or keep open for all) *@
            <button class="btn-primary-action" @onclick="OpenCreateModal">
                <span class="bi bi-plus-lg"></span> New Task
            </button>
        </div>
    </header>

    @* TEAM FILTERS: Updated to also act as a View Filter *@
    <div class="team-filter-bar">
        <button class="tab-btn @(CurrentTeamFilter == "All" ? "active" : "")" @onclick='() => FilterByTeam("All")'>All Roles</button>
        <button class="tab-btn @(CurrentTeamFilter == "Logistics Coordinator" ? "active" : "")" @onclick='() => FilterByTeam("Logistics Coordinator")'>Logistics</button>
        <button class="tab-btn @(CurrentTeamFilter == "Platform Engineer" ? "active" : "")" @onclick='() => FilterByTeam("Platform Engineer")'>Platform</button>
        <button class="tab-btn @(CurrentTeamFilter == "Network Security Engineer" ? "active" : "")" @onclick='() => FilterByTeam("Network Security Engineer")'>NetSec</button>
        <button class="tab-btn @(CurrentTeamFilter == "Cloud Engineer" ? "active" : "")" @onclick='() => FilterByTeam("Cloud Engineer")'>Cloud</button>
        <button class="tab-btn @(CurrentTeamFilter == "Modern Workplace Engineer" ? "active" : "")" @onclick='() => FilterByTeam("Modern Workplace Engineer")'>Modern Work</button>
    </div>

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="alert alert-danger alert-dismissible fade show mb-3" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i> @ErrorMessage
            <button type="button" class="btn-close" @onclick='() => ErrorMessage = ""'></button>
        </div>
    }

    <div class="kanban-board">
        @* COLUMN 1: BACKLOG *@
        <div class="kanban-column">
            <div class="column-header">
                <span>Backlog</span>
                <span class="count-badge">@FilteredTasks.Count(t => t.Status == "Backlog")</span>
            </div>
            <div class="column-body">
                @foreach (var task in FilteredTasks.Where(t => t.Status == "Backlog"))
                {
                    <div class="kanban-card">
                        @RenderCardContent(task)
                        <div class="card-actions">
                            @* RBAC CHECK: Only show move button if allowed *@
                            @if (CanInteractWithTask(task))
                            {
                                <button class="btn-move" @onclick='() => MoveTask(task, "Doing")'>
                                    Start <span class="bi bi-arrow-right-short"></span>
                                </button>
                            }
                            else
                            {
                                <span class="text-muted small fst-italic"><i class="bi bi-lock-fill"></i> View Only</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        @* COLUMN 2: DOING *@
        <div class="kanban-column">
            <div class="column-header">
                <span>In Progress</span>
                <span class="count-badge">@FilteredTasks.Count(t => t.Status == "Doing")</span>
            </div>
            <div class="column-body">
                @foreach (var task in FilteredTasks.Where(t => t.Status == "Doing"))
                {
                    <div class="kanban-card doing-card">
                        @RenderCardContent(task)
                        <div class="card-actions">
                            @if (CanInteractWithTask(task))
                            {
                                <button class="btn-move-back" @onclick='() => MoveTask(task, "Backlog")'>
                                    <span class="bi bi-arrow-left-short"></span>
                                </button>
                                <button class="btn-move" @onclick='() => InitiateCompleteTask(task)'>
                                    Done <span class="bi bi-arrow-right-short"></span>
                                </button>
                            }
                            else
                            {
                                <span class="text-muted small fst-italic"><i class="bi bi-lock-fill"></i> View Only</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>

        @* COLUMN 3: DONE *@
        <div class="kanban-column">
            <div class="column-header">
                <span>Done / Review</span>
                <span class="count-badge">@FilteredTasks.Count(t => t.Status == "PendingReview" || t.Status == "Verified")</span>
            </div>
            <div class="column-body">
                @foreach (var task in FilteredTasks.Where(t => t.Status == "PendingReview" || t.Status == "Verified"))
                {
                    <div class="kanban-card done-card">
                        <div class="card-content">
                            <p class="task-title text-decoration-line-through text-muted">
                                @if (task.Status == "Verified")
                                {
                                    <span class="bi bi-check-circle-fill text-success me-2"></span>
                                }
                                else
                                {
                                    <span class="bi bi-hourglass-split text-warning me-2"></span>
                                }
                                @task.Title
                            </p>

                            <div class="d-flex justify-content-between align-items-center mt-2">
                                @if (task.Status == "PendingReview")
                                {
                                    <span class="badge bg-warning text-dark">Pending Review</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Verified</span>
                                }
                                <span class="team-tag-mini">@GetTeamShortCode(task.AssignedToId)</span>
                            </div>

                            @if (!string.IsNullOrEmpty(task.ProofUrl))
                            {
                                <div class="mt-1 small text-muted"><span class="bi bi-paperclip"></span> Attached</div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@* --- MODALS --- *@

@* 1. NEW TASK MODAL *@
<ToroModal @bind-IsVisible="isCreateModalVisible" Title="Create New Task">
    <div class="modern-modal-form">
        <p class="text-muted mb-3 small">Adding task to <strong>@GetProjectName(SelectedProjectId)</strong></p>

        <div class="alert alert-info py-2 px-3 small mb-3">
            <i class="bi bi-clock-history me-1"></i>
            <strong>Policy:</strong> Teams have a maximum of <strong>5 Days</strong> to complete this task once started.
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Task Title</label>
            <input @bind="NewTaskModel.Title" class="form-control task-input-modern" placeholder="e.g. Configure VNET Peering" />
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Description</label>
            <textarea @bind="NewTaskModel.Description" class="form-control task-input-modern" rows="3" placeholder="Details..."></textarea>
        </div>

        <div class="row">
            <div class="col-6 form-group mb-3">
                <label class="small-label">Start Date</label>
                <input type="text" class="form-control task-input-modern bg-light" value="@DateTime.Now.ToShortDateString()" readonly />
                <small class="text-muted" style="font-size:0.7rem">Automatic</small>
            </div>
            <div class="col-6 form-group mb-3">
                <label class="small-label">Role / Team</label>
                @* If regular user, force their role. If Admin, allow selection *@
                @if (CurrentUserRole == "Admin")
                {
                    <select @bind="NewTaskModel.AssignedToId" class="form-select task-input-modern">
                        <option value="Logistics Coordinator">Logistics Coordinator</option>
                        <option value="Platform Engineer">Platform Engineer</option>
                        <option value="Network Security Engineer">Network Security Engineer</option>
                        <option value="Cloud Engineer">Cloud Engineer</option>
                        <option value="Modern Workplace Engineer">Modern Workplace Engineer</option>
                    </select>
                }
                else
                {
                    <input type="text" class="form-control task-input-modern" value="@NewTaskModel.AssignedToId" disabled />
                    <small class="text-muted">Locked to your role</small>
                }
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 border-top pt-3">
            <button class="btn-cancel-task" @onclick="() => isCreateModalVisible = false">Cancel</button>
            <button class="btn-save-task" @onclick="CreateTaskAsync">Create Task</button>
        </div>
    </div>
</ToroModal>

@* 2. PROOF MODAL *@
<ToroModal @bind-IsVisible="isProofModalVisible" Title="Submit Proof">
    <div class="new-task-form border-0 shadow-none p-0">
        <p class="text-muted mb-3 small">Upload screenshots, logs, or provide a link for <strong>@TaskToComplete?.Title</strong>.</p>

        <div class="form-group mb-2">
            <label class="small-label">Proof Link / URL</label>
            <input @bind="ProofUrlInput" class="form-control task-input-compact" placeholder="https://..." />
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn-cancel-task" @onclick="() => isProofModalVisible = false">Cancel</button>
            <button class="btn-save-task" @onclick="SubmitProofAsync">Submit & Complete</button>
        </div>
    </div>
</ToroModal>

@code {
    // State
    private List<Project> Projects = new();
    private List<ProjectTask> Tasks = new();
    private List<Project> VisibleProjects = new();

    private string CurrentTeamFilter = "All"; // Default view
    private int? SelectedProjectId = null;
    private string ErrorMessage = "";

    // Auth State
    private string CurrentUserRole = "Loading...";
    private bool IsAdmin = false;

    // Models & Modals
    private bool isCreateModalVisible = false;
    private bool isProofModalVisible = false;
    private ProjectTask NewTaskModel = new();
    private ProjectTask? TaskToComplete;
    private string ProofUrlInput = "";

    // Computed Properties
    private IEnumerable<ProjectTask> FilteredTasks => Tasks
        .Where(t => SelectedProjectId == null || t.ProjectId == SelectedProjectId)
        .Where(t => CurrentTeamFilter == "All" || t.AssignedToId == CurrentTeamFilter);

    protected override async Task OnInitializedAsync()
    {
        await LoadUserRoleAsync();
        await LoadDataAsync();
    }

    private async Task LoadUserRoleAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (user.Identity != null && user.Identity.IsAuthenticated)
        {
            // Assuming roles are stored as claims.
            // In a real scenario, you might Map "Role Claim" -> "Job Title" string
            // For this demo, we assume the Role Claim matches the Job Title or we default to a safe value.

            if (user.IsInRole("Admin"))
            {
                IsAdmin = true;
                CurrentUserRole = "Admin";
            }
            else
            {
                // Find the role claim that matches our job titles
                var roleClaim = user.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role);
                CurrentUserRole = roleClaim?.Value ?? "Guest";
            }
        }
    }

    // --- RBAC CORE LOGIC ---
    private bool CanInteractWithTask(ProjectTask task)
    {
        if (IsAdmin) return true; // Admins can do anything

        // Users can only touch tasks assigned to their specific Role
        return task.AssignedToId == CurrentUserRole;
    }
    // -----------------------

    private async Task LoadDataAsync()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();

            Projects = await context.Projects
                .Include(p => p.Client)
                .Include(p => p.Tasks)
                .Where(p => p.Status == "Active")
                .ToListAsync();

            Tasks = Projects.SelectMany(p => p.Tasks).ToList();
            VisibleProjects = Projects;

            // Auto-filter if not Admin
            if (!IsAdmin && CurrentUserRole != "Guest")
            {
                CurrentTeamFilter = CurrentUserRole;
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Error loading data: {ex.Message}";
            Logger.LogError(ex, "Failed to load Kanban data");
        }
    }

    private void FilterByTeam(string team)
    {
        CurrentTeamFilter = team;
        StateHasChanged();
    }

    private void OnProjectSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id)) SelectedProjectId = id;
        else SelectedProjectId = null;
    }

    private string GetProjectName(int? id) => Projects.FirstOrDefault(p => p.Id == id)?.Name ?? "Unknown";

    // --- CREATE TASK ---
    private void OpenCreateModal()
    {
        if (SelectedProjectId == null)
        {
            ErrorMessage = "Please select a Project from the dropdown first.";
            return;
        }

        // RBAC CHECK: Can this user create tasks?
        // (Assuming all team members can create tasks, but we force the assignment)

        ErrorMessage = "";
        NewTaskModel = new ProjectTask
        {
            ProjectId = SelectedProjectId.Value,
            Status = "Backlog",
            // If not admin, force assignment to themselves
            AssignedToId = IsAdmin ? "Platform Engineer" : CurrentUserRole
        };
        isCreateModalVisible = true;
    }

    private async Task CreateTaskAsync()
    {
        if (string.IsNullOrWhiteSpace(NewTaskModel.Title)) return;

        try
        {
            using var context = DbFactory.CreateDbContext();
            // StartDate is handled in Repository or defaulted in Entity
            context.ProjectTasks.Add(NewTaskModel);
            await context.SaveChangesAsync();

            isCreateModalVisible = false;
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"Database Error: {ex.Message}";
        }
    }

    // --- MOVE / UPDATE STATUS ---
    private async Task MoveTask(ProjectTask task, string newStatus)
    {
        // Double Check Logic (Security)
        if (!CanInteractWithTask(task))
        {
            ErrorMessage = "You are not authorized to move this task.";
            return;
        }

        try
        {
            using var context = DbFactory.CreateDbContext();
            var dbTask = await context.ProjectTasks.FindAsync(task.Id);
            if (dbTask != null)
            {
                dbTask.Status = newStatus;
                await context.SaveChangesAsync();
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Failed to move task.";
            Logger.LogError(ex, "Move Task Error");
        }
    }

    // --- COMPLETE / PROOF ---
    private void InitiateCompleteTask(ProjectTask task)
    {
        // Double Check Logic (Security)
        if (!CanInteractWithTask(task)) return;

        TaskToComplete = task;
        ProofUrlInput = "";
        isProofModalVisible = true;
    }

    private async Task SubmitProofAsync()
    {
        if (TaskToComplete == null) return;

        try
        {
            using var context = DbFactory.CreateDbContext();
            var dbTask = await context.ProjectTasks.FindAsync(TaskToComplete.Id);
            if (dbTask != null)
            {
                dbTask.Status = "PendingReview";
                dbTask.ProofUrl = ProofUrlInput;
                await context.SaveChangesAsync();

                isProofModalVisible = false;
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            ErrorMessage = "Failed to submit proof.";
        }
    }

    private RenderFragment RenderCardContent(ProjectTask task) => __builder =>
    {
        <div class="card-content">
            <div class="d-flex justify-content-between align-items-start mb-1">
                <span class="badge-priority medium">Medium</span>
                @if (CurrentTeamFilter == "All")
                {
                    <span class="team-badge-xs">@GetTeamShortCode(task.AssignedToId)</span>
                }
            </div>
            <p class="task-title">@task.Title</p>
            <p class="task-desc">@task.Description</p>
        </div>
    };

    private string GetTeamShortCode(string? fullTeam) => fullTeam switch
    {
        "Logistics Coordinator" => "LOG",
        "Platform Engineer" => "PLATFORM",
        "Network Security Engineer" => "NETSEC",
        "Cloud Engineer" => "CLOUD",
        "Modern Workplace Engineer" => "M365",
        _ => "GEN"
    };
}