@page "/team/kanban"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Components.Forms
@using System.Text.RegularExpressions
@using ToroTrack.Components.Layout
@using ToroTrack.Data
@using ToroTrack.Data.Entities
@using ToroTrack.Models

@rendermode InteractiveServer

@* Enforce Security: Only Team Members and Admins can enter [cite: 78] *@
@attribute [Authorize(Roles = "Admin, TeamMember")]

@inject IDbContextFactory<ApplicationDbContext> DbFactory
@inject ILogger<Kanban> Logger
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager

<PageTitle>Kanban Board | Toro Track</PageTitle>

<div class="page-shell">
    <header class="content-header">
        <div class="header-left">
            <h1 class="page-title">Task Board</h1>
            <p class="page-subtitle">Manage project tasks and workflow.</p>
        </div>

        <div class="header-center">
            <div class="search-wrapper">
                <select class="project-select" @onchange="OnProjectSelected" value="@(SelectedProjectId?.ToString() ?? "")">
                    <option value="">
                        @if (VisibleProjects.Any())
                        {
                            <text>-- Select Active Project --</text>
                        }
                        else
                        {
                            <text>-- No Projects Assigned --</text>
                        }
                    </option>
                    @foreach (var proj in VisibleProjects)
                    {
                        <option value="@proj.Id">@proj.Client?.FirstName @proj.Client?.LastName - @proj.Name</option>
                    }
                </select>
            </div>
        </div>

        <div class="header-right d-flex gap-2 align-items-center">
            <div class="stage-indicator">
                <span class="stage-label">My Job:</span>
                <span class="stage-value">@CurrentUserJobRole</span>
            </div>

            <button class="btn-primary-action" @onclick="OpenCreateModal">
                <span class="bi bi-plus-lg"></span> New Task
            </button>
        </div>
    </header>

    @* --- SNACKBAR COMPONENT --- *@
    @if (!string.IsNullOrEmpty(SuccessMessage))
    {
        <div class="toro-snackbar success">
            <i class="bi bi-check-circle-fill snackbar-icon"></i>
            <span class="snackbar-text">@SuccessMessage</span>
            <button class="snackbar-close" @onclick='() => SuccessMessage = ""'>
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    }

    @if (!string.IsNullOrEmpty(ErrorMessage))
    {
        <div class="toro-snackbar error">
            <i class="bi bi-exclamation-triangle-fill snackbar-icon"></i>
            <span class="snackbar-text">@ErrorMessage</span>
            <button class="snackbar-close" @onclick='() => ErrorMessage = ""'>
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
    }

    <div class="kanban-board">
        @* COLUMN 1: BACKLOG *@
        <div class="kanban-column">
            <div class="column-header">
                <span>Backlog</span>
                <span class="count-badge">@FilteredTasks.Count(t => t.Status == "Backlog")</span>
            </div>
            <div class="column-body">
                @foreach (var task in FilteredTasks.Where(t => t.Status == "Backlog"))
                {
                    @RenderTaskCard(task)
                }
            </div>
        </div>

        @* COLUMN 2: DOING *@
        <div class="kanban-column">
            <div class="column-header">
                <span>In Progress</span>
                <span class="count-badge">@FilteredTasks.Count(t => t.Status == "Doing")</span>
            </div>
            <div class="column-body">
                @foreach (var task in FilteredTasks.Where(t => t.Status == "Doing"))
                {
                    @RenderTaskCard(task)
                }
            </div>
        </div>

        @* COLUMN 3: DONE *@
        <div class="kanban-column">
            <div class="column-header">
                <span>Done / Review</span>
                <span class="count-badge">@FilteredTasks.Count(t => t.Status == "PendingReview" || t.Status == "Verified")</span>
            </div>
            <div class="column-body">
                @foreach (var task in FilteredTasks.Where(t => t.Status == "PendingReview" || t.Status == "Verified"))
                {
                    <div class="kanban-card done-card">
                        <div class="card-content">
                            <p class="task-title text-decoration-line-through text-muted">
                                @if (task.Status == "Verified")
                                {
                                    <span class="bi bi-check-circle-fill text-success me-2"></span>
                                }
                                else
                                {
                                    <span class="bi bi-hourglass-split text-warning me-2"></span>
                                }
                                @task.Title
                            </p>

                            <div class="d-flex justify-content-between align-items-center mt-2">
                                @if (task.Status == "PendingReview")
                                {
                                    <span class="badge bg-warning text-dark">Pending Review</span>
                                }
                                else
                                {
                                    <span class="badge bg-success">Verified</span>
                                }
                                <span class="team-tag-mini">@GetTeamShortCode(task.AssignedToId)</span>
                            </div>

                            @if (!string.IsNullOrEmpty(task.ProofUrl))
                            {
                                <div class="mt-1 small text-muted"><span class="bi bi-paperclip"></span> Attached</div>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@* --- MODALS --- *@

@* NEW TASK MODAL *@
<ToroModal @bind-IsVisible="isCreateModalVisible" Title="Create New Task">
    <div class="modern-modal-form">
        <p class="text-muted mb-3 small">Adding task to <strong>@GetProjectName(SelectedProjectId)</strong></p>

        <div class="alert alert-info py-2 px-3 small mb-3">
            <i class="bi bi-clock-history me-1"></i>
            <strong>Policy:</strong> The 5-day timer starts <strong>NOW</strong>. Only create this task if you are ready to begin.
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Select Stage</label>
            <select class="form-select task-input-modern" @onchange="OnStageSelected">
                <option value="">-- Select a Stage to Start --</option>
                @foreach (var stage in StageOptions)
                {
                    <option value="@stage.Title">@stage.Title</option>
                }
                <option value="Custom">Custom / Ad-hoc Task</option>
            </select>
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Task Title</label>
            <input @bind="NewTaskModel.Title" class="form-control task-input-modern"
                   placeholder="Task Title will appear here..."
                   readonly="@(!IsCustomTask)" />
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Description</label>
            <textarea @bind="NewTaskModel.Description" class="form-control task-input-modern" rows="3"
                      placeholder="Task details..."
                      readonly="@(!IsCustomTask)"></textarea>
        </div>

        <div class="row">
            <div class="col-6 form-group mb-3">
                <label class="small-label">Start Date</label>
                <input type="text" class="form-control task-input-modern bg-light" value="@DateTime.Now.ToShortDateString()" readonly />
                <small class="text-muted" style="font-size:0.7rem">Starts Today</small>
            </div>
            <div class="col-6 form-group mb-3">
                <label class="small-label">Role / Team</label>
                <input type="text" class="form-control task-input-modern bg-light" value="@NewTaskModel.AssignedToId" disabled />
            </div>
        </div>

        <div class="d-flex justify-content-end gap-2 border-top pt-3">
            <button class="btn-cancel-task" @onclick="() => isCreateModalVisible = false">Cancel</button>
            <button class="btn-save-task" @onclick="CreateTaskAsync">Start Task</button>
        </div>
    </div>
</ToroModal>

@* PROOF MODAL *@
<ToroModal @bind-IsVisible="isProofModalVisible" Title="Submit Proof">
    <div class="new-task-form border-0 shadow-none p-0">
        <p class="text-muted mb-3 small">Upload screenshots, logs, or provide a link for <strong>@TaskToComplete?.Title</strong>.</p>

        <div class="form-group mb-2">
            <label class="small-label">Proof Link / URL</label>
            <input @bind="ProofUrlInput" class="form-control task-input-compact" placeholder="https://..." />
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Or Upload File</label>
            <InputFile OnChange="HandleFileSelected" class="form-control task-input-compact" />
            @if (!string.IsNullOrEmpty(ProofModel.FileName))
            {
                <div class="text-success small mt-1"><span class="bi bi-check2"></span> @ProofModel.FileName attached</div>
            }
        </div>

        <div class="d-flex justify-content-end gap-2 mt-3">
            <button class="btn-cancel-task" @onclick="() => isProofModalVisible = false">Cancel</button>
            <button class="btn-save-task" @onclick="SubmitProofAsync">Submit & Complete</button>
        </div>
    </div>
</ToroModal>

@* 3. ORDER REVIEW MODAL (STAGE 2) *@
<ToroModal @bind-IsVisible="isOrderReviewVisible" Title="Review Order Request">
    <div class="modern-modal-form" style="max-width: 650px;">
        @if (CurrentProjectOrder == null)
        {
            <div class="alert alert-warning text-center rounded-3 shadow-sm border-0 my-4">
                <i class="bi bi-search me-2"></i> No active order found for this project.
            </div>
        }
        else
        {
            <p class="text-muted mb-3 small">Review items requested by client <strong>@CurrentProjectOrder.Client?.FullName</strong>.</p>
            <div class="bg-light p-3 rounded-3 border mb-3">
                <div class="row g-2">
                    <div class="col-8">
                        <label class="small-label">Client Name</label>
                        <div class="fw-bold text-dark">@CurrentProjectOrder.Client?.FullName</div>
                        <small class="text-muted">@CurrentProjectOrder.Client?.Email</small>
                    </div>
                    <div class="col-4 text-end">
                        <label class="small-label">Status</label>
                        <span class="badge bg-white text-dark border">@CurrentProjectOrder.Status</span>
                    </div>
                </div>
            </div>

            <label class="small-label mb-2">Requested Items</label>
            <div class="border rounded-3 overflow-hidden shadow-sm bg-white mb-4">
                <div class="d-flex bg-light p-2 small fw-bold text-muted border-bottom">
                    <div class="flex-grow-1 ps-2">Product</div>
                    <div class="text-center" style="width: 60px;">Qty</div>
                    <div class="text-end pe-2" style="width: 140px;">Availability</div>
                </div>

                <div style="max-height: 250px; overflow-y: auto;">
                    @foreach (var item in CurrentProjectOrder.Items)
                    {
                        <div class="d-flex align-items-center p-2 border-bottom hover-bg-light">
                            <div class="flex-grow-1 ps-2">
                                <span class="fw-bold text-dark d-block" style="font-size: 0.9rem;">
                                    @item.CatalogItem?.Name
                                </span>
                            </div>
                            <div class="text-center" style="width: 60px;">
                                <span class="badge bg-light text-dark border">x @item.Quantity</span>
                            </div>
                            <div class="text-end pe-2" style="width: 140px;">
                                @if (IsStockSufficient(item))
                                {
                                    <div class="text-success fw-bold" style="font-size: 0.8rem;">
                                        <i class="bi bi-check-circle-fill"></i> In Stock
                                    </div>
                                }
                                else
                                {
                                    <div class="text-danger fw-bold" style="font-size: 0.8rem;">
                                        <i class="bi bi-exclamation-octagon-fill"></i> Low Stock
                                    </div>
                                }
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="d-flex justify-content-between pt-2 border-top">
                <button class="btn-cancel-task text-danger border-danger" @onclick='() => ProcessOrderDecision("Low Stock")'>
                    <i class="bi bi-flag me-1"></i> Report Issue
                </button>
                <button class="btn-save-task" @onclick='() => ProcessOrderDecision("Confirmed")'>
                    Confirm & Allocate
                </button>
            </div>
        }
    </div>
</ToroModal>

@* 4. ASSET REGISTRATION MODAL (STAGE 4) *@
<ToroModal @bind-IsVisible="isAssetRegModalVisible" Title="Asset Registration">
    <div class="modern-modal-form" style="max-width: 600px;">
        <p class="text-muted mb-3 small">
            Scan/Enter serial numbers for project: <strong>@GetProjectName(ActiveProcessingProjectId)</strong>.
        </p>

        @* Simulate list of assets needing tags based on Order *@
        <div class="alert alert-light border small mb-3">
            <i class="bi bi-info-circle me-1"></i> Use barcode scanner or manual entry for hardware assets.
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Serial Numbers (One per line)</label>
            <textarea class="form-control task-input-modern" rows="5"
                      placeholder="SN-1002394..."
                      @bind="AssetSerialNumbersInput"></textarea>
        </div>

        <div class="d-flex justify-content-end gap-2 border-top pt-3">
            <button class="btn-cancel-task" @onclick="() => isAssetRegModalVisible = false">Cancel</button>
            <button class="btn-save-task" @onclick="SubmitAssetRegistration">
                <i class="bi bi-upc-scan me-1"></i> Register Assets
            </button>
        </div>
    </div>
</ToroModal>

@* 5. FINAL DISPATCH MODAL (STAGE 5) *@
<ToroModal @bind-IsVisible="isDispatchModalVisible" Title="Final Dispatch">
    <div class="modern-modal-form">
        <p class="text-muted mb-3 small">
            Confirm courier details for project: <strong>@GetProjectName(ActiveProcessingProjectId)</strong>.
        </p>

        <div class="form-group mb-3">
            <label class="small-label">Courier Service</label>
            @* Added @oninput to trigger regeneration when courier changes *@
            <select class="form-select task-input-modern" @onchange="OnCourierChanged">
                <option value="FedEx">FedEx Express</option>
                <option value="DHL">DHL Supply Chain</option>
                <option value="RAM">RAM Hand-to-Hand</option>
                <option value="Internal">Internal Fleet</option>
            </select>
        </div>

        <div class="form-group mb-3">
            <label class="small-label">Tracking / Waybill Number</label>
            <div class="input-group">
                <input type="text" class="form-control task-input-modern"
                       placeholder="WAYBILL-XXXXXXXX"
                       @bind="DispatchData.TrackingNumber" />

                @* Allow manual regeneration if needed *@
                <button class="btn btn-outline-secondary" type="button"
                        @onclick="() => DispatchData.TrackingNumber = GenerateTrackingNumber(DispatchData.CourierName)"
                        title="Generate New Number">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
            <small class="text-muted" style="font-size: 0.7rem;">
                <i class="bi bi-magic"></i> Auto-generated. Edit manually if using pre-printed labels.
            </small>
        </div>

        <div class="form-group mb-4">
            <label class="small-label">Notes</label>
            <textarea class="form-control task-input-modern" rows="2"
                      placeholder="Gate code, contact person..."
                      @bind="DispatchData.Notes"></textarea>
        </div>

        <div class="d-flex justify-content-end gap-2 border-top pt-3">
            <button class="btn-cancel-task" @onclick="() => isDispatchModalVisible = false">Cancel</button>
            <button class="btn-save-task" @onclick="SubmitDispatch">
                <i class="bi bi-truck me-1"></i> Dispatch & Close
            </button>
        </div>
    </div>
</ToroModal>

@code {
    // --- State & Auth ---
    private List<Project> Projects = new();
    private List<ProjectTask> Tasks = new();
    private List<Project> VisibleProjects = new();

    private string CurrentTeamFilter = "All";
    private int? SelectedProjectId = null;
    private string ErrorMessage = "";
    private string SuccessMessage = "";
    private string CurrentUserJobRole = "Loading...";
    private string CurrentUserIdentityRole = "";
    private bool IsAdmin = false;

    // --- Models & UI Logic ---
    private bool isCreateModalVisible = false;
    private bool isProofModalVisible = false;
    private bool isOrderReviewVisible = false;

    // --- NEW MODAL STATES ---
    private bool isAssetRegModalVisible = false;
    private bool isDispatchModalVisible = false;

    // Holds the ID of the project currently being processed in a stage modal
    private int? ActiveProcessingProjectId = null;
    private ProjectTask? ActiveProcessingTask = null;

    // Input Models
    private ProjectTask NewTaskModel = new();
    private ProjectTask? TaskToComplete;
    private AssetOrder? CurrentProjectOrder;
    private string ProofUrlInput = "";
    private string AssetSerialNumbersInput = "";

    // Simple DTO for Dispatch
    private class DispatchModel
    {
        public string CourierName { get; set; } = "FedEx";
        public string TrackingNumber { get; set; } = "";
        public string Notes { get; set; } = "";
    }
    private DispatchModel DispatchData = new();

    // Stage Logic
    private List<(string Title, string Description)> StageOptions = new();
    private bool IsCustomTask = false;

    private class ProofOfWork { public string FileName { get; set; } = ""; }
    private ProofOfWork ProofModel = new();

    private IEnumerable<ProjectTask> FilteredTasks => Tasks
        .Where(t => SelectedProjectId == null || t.ProjectId == SelectedProjectId)
        .Where(t => CurrentTeamFilter == "All" || t.AssignedToId == CurrentTeamFilter);

    protected override async Task OnInitializedAsync()
    {
        await LoadUserRoleAsync();
        await LoadDataAsync();
    }

    // Helper to Show and Auto-Dismiss Messages
    private async Task ShowSuccess(string message)
    {
        SuccessMessage = message;
        ErrorMessage = "";
        await InvokeAsync(StateHasChanged);

        _ = Task.Delay(5000).ContinueWith(async _ =>
        {
            if (SuccessMessage == message)
            {
                SuccessMessage = "";
                await InvokeAsync(StateHasChanged);
            }
        });
    }

    private async Task ShowError(string message)
    {
        ErrorMessage = message;
        SuccessMessage = "";
        await InvokeAsync(StateHasChanged);

        _ = Task.Delay(5000).ContinueWith(async _ =>
        {
            if (ErrorMessage == message)
            {
                ErrorMessage = "";
                await InvokeAsync(StateHasChanged);
            }
        });
    }

    private async Task LoadUserRoleAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        if (principal.Identity?.IsAuthenticated == true)
        {
            if (principal.IsInRole("Admin"))
            {
                IsAdmin = true;
                CurrentUserIdentityRole = "Admin";
                CurrentUserJobRole = "Admin";
            }
            else if (principal.IsInRole("TeamMember"))
            {
                CurrentUserIdentityRole = "TeamMember";
                try
                {
                    var user = await UserManager.GetUserAsync(principal);
                    CurrentUserJobRole = user?.JobRole ?? "Unassigned";
                }
                catch (Exception ex)
                {
                    Logger.LogError(ex, "Failed to load user details");
                    CurrentUserJobRole = "Error";
                }
            }
        }
    }

    private bool CanInteractWithTask(ProjectTask task)
    {
        if (IsAdmin) return true;
        return task.AssignedToId == CurrentUserJobRole;
    }

    private async Task LoadDataAsync()
    {
        try
        {
            using var context = DbFactory.CreateDbContext();

            // Build query for projects
            var projectQuery = context.Projects
                .Include(p => p.Client)
                .Include(p => p.Tasks)
                .Where(p => p.Status == "Active");

            // --- STRICT FILTERING FOR TEAM MEMBERS ---
            // Ensure they only see projects assigned to their team
            if (!IsAdmin && !string.IsNullOrEmpty(CurrentUserJobRole) && CurrentUserJobRole != "Unassigned")
            {
                projectQuery = projectQuery.Where(p => p.AssignedTeam == CurrentUserJobRole);
            }

            Projects = await projectQuery.ToListAsync();
            Tasks = Projects.SelectMany(p => p.Tasks).ToList();
            VisibleProjects = Projects; // Now strictly filtered

            if (!IsAdmin && CurrentUserJobRole != "Unassigned" && CurrentUserJobRole != "Loading...")
            {
                CurrentTeamFilter = CurrentUserJobRole;
            }
        }
        catch (Exception ex)
        {
            ShowError($"Error loading data: {ex.Message}");
            Logger.LogError(ex, "Failed to load Kanban data");
        }
    }

    private void OnProjectSelected(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out int id)) SelectedProjectId = id;
        else SelectedProjectId = null;
    }

    private string GetProjectName(int? id) => Projects.FirstOrDefault(p => p.Id == id)?.Name ?? "Unknown";

    // --- TASK LOGIC ---
    private void OpenCreateModal()
    {
        if (SelectedProjectId == null)
        {
            ShowError("Please select a Project from the dropdown first.");
            return;
        }

        // --- SECONDARY SECURITY CHECK ---
        // Ensure user hasn't manipulated HTML to select a hidden project ID
        var project = Projects.FirstOrDefault(p => p.Id == SelectedProjectId);
        if (project == null || (!IsAdmin && project.AssignedTeam != CurrentUserJobRole))
        {
            ShowError("Access Denied: This project belongs to another team.");
            return;
        }

        ErrorMessage = "";
        NewTaskModel = new ProjectTask
        {
            ProjectId = SelectedProjectId.Value,
            Status = "Backlog",
            AssignedToId = IsAdmin ? "Platform Engineer" : CurrentUserJobRole
        };

        LoadStagesForRole(NewTaskModel.AssignedToId);
        IsCustomTask = false;

        isCreateModalVisible = true;
    }

    private void OnStageSelected(ChangeEventArgs e)
    {
        var selectedTitle = e.Value?.ToString();
        if (selectedTitle == "Custom")
        {
            IsCustomTask = true;
            NewTaskModel.Title = "";
            NewTaskModel.Description = "";
        }
        else
        {
            IsCustomTask = false;
            var stage = StageOptions.FirstOrDefault(s => s.Title == selectedTitle);
            if (stage != default)
            {
                NewTaskModel.Title = stage.Title;
                NewTaskModel.Description = stage.Description;
            }
        }
    }

    private void LoadStagesForRole(string role)
    {
        StageOptions = role switch
        {
            "Logistics Coordinator" => new()
            {
                ("Stage 1: Catalog Verification", "Review the 'Catalog' page. Ensure stock levels are accurate."),
                ("Stage 2: Order Monitoring", "Monitor incoming requests on the 'Verify Tasks' or Orders page."),
                ("Stage 3: Stock Allocation", "Physically set aside hardware in the warehouse."),
                ("Stage 4: Asset Registration", "Register serial numbers in the 'Assets' system."),
                ("Stage 5: Final Dispatch", "Coordinate courier pickup and mark project as deployed.")
            },
            "Platform Engineer" => new()
            {
                ("Stage 1: Infrastructure Audit", "Assess current on-premise server environment."),
                ("Stage 2: Virtualization Setup", "Configure Hyper-V/VMware host environment."),
                ("Stage 3: Server Provisioning", "Deploy Windows Server instances."),
                ("Stage 4: Backup Configuration", "Setup local and offsite backup routines."),
                ("Stage 5: Disaster Recovery Test", "Simulate failure and verify recovery.")
            },
            "Network Security Engineer" => new()
            {
                ("Stage 1: Network Mapping", "Document existing IP schema and topology."),
                ("Stage 2: Firewall Configuration", "Configure VLANs and inbound/outbound rules."),
                ("Stage 3: VPN Tunneling", "Setup secure Site-to-Site or Client VPNs."),
                ("Stage 4: Penetration Testing", "Run vulnerability scan and patch critical risks."),
                ("Stage 5: Security Sign-off", "Generate security report and obtain client approval.")
            },
            "Cloud Engineer" => new()
            {
                ("Stage 1: Tenant Initialization", "Setup Azure/AWS tenant and billing alerts."),
                ("Stage 2: Identity Sync", "Configure Azure AD Connect for user synchronization."),
                ("Stage 3: Data Migration", "Execute lift-and-shift of file server data to cloud."),
                ("Stage 4: Cutover", "Switch DNS records and go live."),
                ("Stage 5: Post-Migration Support", "Monitor logs for 48 hours and resolve sync errors.")
            },
            "Modern Workplace Engineer" => new()
            {
                ("Stage 1: M365 Licensing", "Assign Business Premium licenses to users."),
                ("Stage 2: Email Migration", "Migrate Exchange mailboxes to Exchange Online."),
                ("Stage 3: Endpoint Manager", "Enroll devices in Intune/Autopilot."),
                ("Stage 4: Policy Deployment", "Push security policies (BitLocker, MFA)."),
                ("Stage 5: User Training", "Conduct Teams/OneDrive training session.")
            },
            _ => new()
        };
    }

    private async Task CreateTaskAsync()
    {
        if (string.IsNullOrWhiteSpace(NewTaskModel.Title)) return;
        try
        {
            using var context = DbFactory.CreateDbContext();
            NewTaskModel.StartDate = DateTime.UtcNow;
            NewTaskModel.DueDate = DateTime.UtcNow.AddDays(5);

            context.ProjectTasks.Add(NewTaskModel);
            await context.SaveChangesAsync();

            isCreateModalVisible = false;
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            ShowError($"Database Error: {ex.Message}");
        }
    }

    // --- PIPELINED DEPENDENCY LOGIC ---
    private bool CheckDependencies(ProjectTask task)
    {
        // Regex to find "Stage X" in title
        var match = Regex.Match(task.Title, @"^Stage (\d+):");
        if (match.Success)
        {
            if (int.TryParse(match.Groups[1].Value, out int currentStage) && currentStage > 1)
            {
                int prevStageNum = currentStage - 1;
                // Find the task for the previous stage in the same project
                var prevTask = Tasks.FirstOrDefault(t =>
                    t.ProjectId == task.ProjectId &&
                    t.Title.StartsWith($"Stage {prevStageNum}:"));

                if (prevTask == null)
                {
                    ShowError($"Locked: 'Stage {prevStageNum}' must be created first.");
                    return false;
                }

                // We check if the previous stage is DONE by the TEAM (PendingReview) OR Verified by Admin.
                bool isPrevTaskDoneByTeam = prevTask.Status == "PendingReview" || prevTask.Status == "Verified";
                if (!isPrevTaskDoneByTeam)
                {
                    ShowError($"Locked: You must complete 'Stage {prevStageNum}' before finishing 'Stage {currentStage}'.");
                    return false;
                }
            }
        }
        return true;
    }

    private async Task MoveTask(ProjectTask task, string newStatus)
    {
        if (!CanInteractWithTask(task))
        {
            await ShowError("You are not authorized to move this task.");
            return;
        }

        try
        {
            using var context = DbFactory.CreateDbContext();
            var dbTask = await context.ProjectTasks.FindAsync(task.Id);
            if (dbTask != null)
            {
                dbTask.Status = newStatus;
                await context.SaveChangesAsync();
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            await ShowError("Failed to move task.");
        }
    }

    private void InitiateCompleteTask(ProjectTask task)
    {
        if (!CanInteractWithTask(task)) return;
        // ENFORCE DEPENDENCY CHECK WHEN COMPLETING (Doing -> Done)
        // This ensures Stage 2 cannot be marked Done until Stage 1 is Done (PendingReview or Verified)
        if (!CheckDependencies(task)) return;

        TaskToComplete = task;
        ProofUrlInput = "";
        isProofModalVisible = true;
    }

    private void HandleFileSelected(InputFileChangeEventArgs e)
    {
        ProofModel.FileName = e.File.Name;
    }

    private async Task SubmitProofAsync()
    {
        if (TaskToComplete == null) return;
        try
        {
            using var context = DbFactory.CreateDbContext();
            var dbTask = await context.ProjectTasks.FindAsync(TaskToComplete.Id);
            if (dbTask != null)
            {
                dbTask.Status = "PendingReview";
                dbTask.ProofUrl = string.IsNullOrWhiteSpace(ProofUrlInput) ? ProofModel.FileName : ProofUrlInput;
                await context.SaveChangesAsync();
                isProofModalVisible = false;
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            await ShowError("Failed to submit proof.");
        }
    }

    // --- ORDER REVIEW LOGIC ---

    private async Task OpenOrderReviewModal(int projectId)
    {
        try
        {
            using var context = DbFactory.CreateDbContext();
            CurrentProjectOrder = await context.AssetOrders
                .Include(o => o.Client)
                .Include(o => o.Items)
                .ThenInclude(i => i.CatalogItem)
                .Where(o => o.ProjectId == projectId)
                .OrderByDescending(o => o.OrderDate)
                .FirstOrDefaultAsync();

            isOrderReviewVisible = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to open order review for project {ProjectId}", projectId);
            await ShowError("Could not load order details.");
        }
    }

    private void CloseOrderReview()
    {
        isOrderReviewVisible = false;
        CurrentProjectOrder = null;
    }

    // Helper to keep logic out of the View for better readability
    private bool IsStockSufficient(OrderItem item)
    {
        if (item.CatalogItem == null) return false;
        return item.CatalogItem.StockQuantity >= item.Quantity;
    }

    private async Task ProcessOrderDecision(string newStatus)
    {
        if (CurrentProjectOrder == null)
        {
            Logger.LogWarning("Attempted to update order status but CurrentProjectOrder is null.");
            return;
        }

        try
        {
            Logger.LogInformation("User {User} setting Order {OrderId} to {Status}",
                CurrentUserJobRole, CurrentProjectOrder.Id, newStatus);

            using var context = DbFactory.CreateDbContext();

            // Re-fetch order with items included to handle stock deduction
            var order = await context.AssetOrders
                .Include(o => o.Items)
                .ThenInclude(i => i.CatalogItem)
                .FirstOrDefaultAsync(o => o.Id == CurrentProjectOrder.Id);

            if (order != null)
            {
                bool stockUpdated = false;
                if (newStatus == "Confirmed")
                {
                    foreach (var item in order.Items)
                    {
                        if (item.CatalogItem != null && item.CatalogItem.Category == "Hardware")
                        {
                            item.CatalogItem.StockQuantity -= item.Quantity;
                            if (item.CatalogItem.StockQuantity < 0)
                            {
                                item.CatalogItem.StockQuantity = 0;
                            }

                            context.Entry(item.CatalogItem).State = EntityState.Modified;
                            stockUpdated = true;
                        }
                    }
                }

                order.Status = newStatus;
                await context.SaveChangesAsync();

                CurrentProjectOrder.Status = newStatus;

                var msg = stockUpdated
                    ? $"Order Confirmed! Stock inventory updated for {order.Items.Count} items."
                    : $"Order status updated to {newStatus}.";

                isOrderReviewVisible = false;
                await InvokeAsync(StateHasChanged);
                await LoadDataAsync();
                await ShowSuccess(msg);
            }
            else
            {
                await ShowError("Order not found in database.");
                await InvokeAsync(StateHasChanged);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update order status for Order {Id}", CurrentProjectOrder.Id);
            await ShowError("System error processing order. Please check logs.");
            await InvokeAsync(StateHasChanged);
        }
    }

    // --- LOGISTICS MODAL LOGIC STAGE 4 & 5 ---

    private void OpenAssetRegistration(int projectId, ProjectTask task)
    {
        ActiveProcessingProjectId = projectId;
        ActiveProcessingTask = task;
        AssetSerialNumbersInput = ""; // Clear previous
        isAssetRegModalVisible = true;
    }

    // Helper to generate smart tracking numbers
    private string GenerateTrackingNumber(string courierName)
    {
        // Why: Standardize format {PREFIX}-{DATE}-{UNIQUE_ID} for easy tracking
        string prefix = courierName switch
        {
            "FedEx" => "FDX",
            "DHL" => "DHL",
            "RAM" => "RAM",
            "Internal" => "INT", // Internal Fleet
            _ => "GEN"
        };

        string datePart = DateTime.Now.ToString("yyMMdd");
        string uniquePart = Guid.NewGuid().ToString().Substring(0, 6).ToUpper();

        return $"{prefix}-{datePart}-{uniquePart}";
    }

    // 2. Updated Open Method to trigger generation
    private void OpenDispatchModal(int projectId, ProjectTask task)
    {
        ActiveProcessingProjectId = projectId;
        ActiveProcessingTask = task;

        // Reset Model
        DispatchData = new DispatchModel();

        // Auto-generate immediately so the user doesn't have to type
        DispatchData.CourierName = "FedEx"; // Default
        DispatchData.TrackingNumber = GenerateTrackingNumber(DispatchData.CourierName);

        Logger.LogInformation("Opened Dispatch Modal. Auto-generated tracking: {Tracking}", DispatchData.TrackingNumber);

        isDispatchModalVisible = true;
    }

    // Handle Courier Change to re-generate number if needed
    private void OnCourierChanged(ChangeEventArgs e)
    {
        var newCourier = e.Value?.ToString() ?? "FedEx";
        DispatchData.CourierName = newCourier;

        // Only auto-regenerate if the field is empty or looks like a system-generated ID
        // This prevents overwriting a number the user might have manually pasted
        if (string.IsNullOrWhiteSpace(DispatchData.TrackingNumber) || DispatchData.TrackingNumber.Contains("-"))
        {
            DispatchData.TrackingNumber = GenerateTrackingNumber(newCourier);
        }
    }

    private async Task SubmitAssetRegistration()
    {
        // Guard clause for validation
        if (ActiveProcessingTask == null) return;
        if (string.IsNullOrWhiteSpace(AssetSerialNumbersInput))
        {
            await ShowError("Please enter at least one serial number.");
            return;
        }

        try
        {
            Logger.LogInformation("Registering assets for Project {Id}", ActiveProcessingProjectId);

            using var context = DbFactory.CreateDbContext();
            var task = await context.ProjectTasks.FindAsync(ActiveProcessingTask.Id);

            if (task != null)
            {
                task.Status = "PendingReview";
                task.ProofUrl = "Assets Registered in System"; // Auto-proof

                await context.SaveChangesAsync();
                await ShowSuccess("Assets registered successfully.");

                isAssetRegModalVisible = false;
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error registering assets");
            await ShowError("Failed to save asset data.");
        }
    }

    private async Task SubmitDispatch()
    {
        if (ActiveProcessingTask == null) return;
        if (string.IsNullOrWhiteSpace(DispatchData.TrackingNumber))
        {
            await ShowError("Tracking Number is required.");
            return;
        }

        try
        {
            using var context = DbFactory.CreateDbContext();
            var task = await context.ProjectTasks
                .Include(t => t.Project) // Include Project to get ClientId
                .FirstOrDefaultAsync(t => t.Id == ActiveProcessingTask.Id);

            if (task != null)
            {
                // Mark Task Complete
                task.Status = "PendingReview";
                task.ProofUrl = $"{DispatchData.CourierName}: {DispatchData.TrackingNumber}";

                // Find the confirmed order for this project
                var approvedOrder = await context.AssetOrders
                    .Include(o => o.Items)
                    .ThenInclude(i => i.CatalogItem)
                    .FirstOrDefaultAsync(o => o.ProjectId == task.ProjectId && o.Status == "Confirmed");

                if (approvedOrder != null)
                {
                    foreach (var item in approvedOrder.Items)
                    {
                        // Create one asset entry per quantity (if Qty=2, create 2 assets)
                        for (int i = 0; i < item.Quantity; i++)
                        {
                            var newAsset = new ClientAsset
                            {
                                ClientId = approvedOrder.ClientId,
                                CatalogItemId = item.CatalogItemId,
                                Name = item.CatalogItem?.Name ?? "Dispatched Item",
                                Description = $"Delivered via {DispatchData.CourierName} (Waybill: {DispatchData.TrackingNumber})",
                                AssignedDate = DateTime.UtcNow,
                                Status = "Active",
                                // Generate a unique serial if one wasn't manually scanned in Stage 4
                                SerialNumber = $"AUTO-{Guid.NewGuid().ToString().Substring(0, 8).ToUpper()}"
                            };
                            context.ClientAssets.Add(newAsset);
                        }
                    }

                    // Mark order as fully delivered
                    approvedOrder.Status = "Delivered";
                }

                await context.SaveChangesAsync();
                await ShowSuccess("Project Dispatched & Assets automatically added to Client Inventory!");

                isDispatchModalVisible = false;
                await LoadDataAsync();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error dispatching project");
            ShowError("Failed to submit dispatch.");
        }
    }

    // --- RENDER LOGIC ---
    private RenderFragment RenderTaskCard(ProjectTask task) => __builder =>
    {
        <div class="kanban-card">
            <div class="card-content">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <span class="badge-priority medium">Medium</span>
                    @if (CurrentTeamFilter == "All")
                    {
                        <span class="team-badge-xs">@GetTeamShortCode(task.AssignedToId)</span>
                    }
                </div>
                <p class="task-title">@task.Title</p>
                <p class="task-desc">@task.Description</p>
            </div>

            @* --- SMART ACTION BUTTONS --- *@
            @* Logic flattened to avoid deep nesting *@

            @{
                // Check for Logistics Specific Actions first
                if (task.AssignedToId == "Logistics Coordinator")
                {
                    if (task.Title.Contains("Stage 2"))
                    {
                        <button class="btn btn-sm btn-outline-dark w-100 mb-2 mt-2"
                                @onclick="() => OpenOrderReviewModal(task.ProjectId)"
                                style="font-size: 0.75rem; border-style: dashed;">
                            <i class="bi bi-clipboard-check"></i> Review Client Order
                        </button>
                    }
                    else if (task.Title.Contains("Stage 4"))
                    {
                        <button class="btn btn-sm btn-outline-dark w-100 mb-2 mt-2"
                                @onclick="() => OpenAssetRegistration(task.ProjectId, task)"
                                style="font-size: 0.75rem; border-style: dashed;">
                            <i class="bi bi-upc-scan"></i> Register Assets
                        </button>
                    }
                    else if (task.Title.Contains("Stage 5"))
                    {
                        <button class="btn btn-sm btn-outline-dark w-100 mb-2 mt-2"
                                @onclick="() => OpenDispatchModal(task.ProjectId, task)"
                                style="font-size: 0.75rem; border-style: dashed;">
                            <i class="bi bi-truck"></i> Final Dispatch
                        </button>
                    }
                    else if (!string.IsNullOrEmpty(GetActionLink(task.Title)))
                    {
                        // Fallback for Stage 1/3 or others
                        <a href="@GetActionLink(task.Title)" class="btn btn-sm btn-outline-dark w-100 mb-2 mt-2"
                           style="font-size: 0.75rem; border-style: dashed;">
                            <span class="bi bi-box-arrow-up-right"></span> Go to Task Page
                        </a>
                    }
                }
                // General Links for other roles
                else if (!string.IsNullOrEmpty(GetActionLink(task.Title)))
                {
                    <a href="@GetActionLink(task.Title)" class="btn btn-sm btn-outline-dark w-100 mb-2 mt-2"
                       style="font-size: 0.75rem; border-style: dashed;">
                        <span class="bi bi-box-arrow-up-right"></span> Go to Task Page
                    </a>
                }
            }

            <div class="card-actions">
                @if (task.Status == "Backlog")
                {
                    @if (CanInteractWithTask(task))
                    {
                        <button class="btn-move" @onclick='() => MoveTask(task, "Doing")'>
                            Start <span class="bi bi-arrow-right-short"></span>
                        </button>
                    }
                    else
                    {
                        <span class="text-muted small fst-italic"><i class="bi bi-lock-fill"></i> View Only</span>
                    }
                }
                else if (task.Status == "Doing")
                {
                    @if (CanInteractWithTask(task))
                    {
                        <button class="btn-move-back" @onclick='() => MoveTask(task, "Backlog")'>
                            <span class="bi bi-arrow-left-short"></span>
                        </button>
                        <button class="btn-move" @onclick='() => InitiateCompleteTask(task)'>
                            Done <span class="bi bi-arrow-right-short"></span>
                        </button>
                    }
                    else
                    {
                        <span class="text-muted small fst-italic"><i class="bi bi-lock-fill"></i> View Only</span>
                    }
                }
            </div>
        </div>
    };

    // --- SMART LINKING ---
    private string? GetActionLink(string title)
    {
        // 1. Specific Workflow Links for Logistics Coordinator
        if (title.Contains("Stage 1") || title.Contains("Catalog")) return "/admin/catalog"; // Catalog Verification
        if (title.Contains("Stage 3") || title.Contains("Stock")) return "/admin/catalog";   // Stock Allocation

        // Removed Stage 4/5 here because they now use buttons
        // This ensures the button appears instead of a link

        // 2. Fallback / General Keywords
        if (title.Contains("Order", StringComparison.OrdinalIgnoreCase) || title.Contains("Verify", StringComparison.OrdinalIgnoreCase)) return "/admin/verify";
        if (title.Contains("Asset", StringComparison.OrdinalIgnoreCase) && !title.Contains("Tag", StringComparison.OrdinalIgnoreCase)) return "/admin/catalog";

        return null;
    }

    private string GetTeamShortCode(string? fullTeam) => fullTeam switch
    {
        "Logistics Coordinator" => "LOG",
        "Platform Engineer" => "PLATFORM",
        "Network Security Engineer" => "NETSEC",
        "Cloud Engineer" => "CLOUD",
        "Modern Workplace Engineer" => "M365",
        _ => "GEN"
    };
}